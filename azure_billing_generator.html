<!DOCTYPE html>
<!--
Azure Billing Report Generator
Made by Rodrigo Quintian
Licensed under Apache 2.0 License
GitHub: https://github.com/cafasdon/azurebillreport
-->
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure Billing Report Generator</title>

    <!-- External Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .step {
            display: flex;
            align-items: center;
            margin: 0 1rem;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            background: #f8f9fa;
            color: #6c757d;
        }

        .step.active {
            background: #007bff;
            color: white;
        }

        .step.completed {
            background: #28a745;
            color: white;
        }

        .upload-zone {
            border: 2px dashed #007bff;
            border-radius: 10px;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-zone:hover {
            background: #f8f9fa;
            border-color: #0056b3;
        }

        .upload-zone.dragover {
            background: #e3f2fd;
            border-color: #1976d2;
        }

        /* Removed currency selection styles - now using fixed GBP currency */

        .progress {
            height: 8px;
        }

        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: 1px solid rgba(0, 0, 0, 0.125);
        }

        /* Native HTML Details/Summary Styling */
        .resource-hierarchy {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        details {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            background: #f8f9fa;
        }

        details[open] {
            background: #e3f2fd;
            border-color: #007bff;
        }

        summary {
            padding: 0.75rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            transition: all 0.3s;
        }

        summary:hover {
            background: rgba(0, 123, 255, 0.1);
        }

        .resource-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .resource-details {
            flex-grow: 1;
        }

        .resource-name {
            font-weight: 600;
            color: #333;
        }

        .resource-type {
            font-size: 0.85em;
            color: #666;
            margin-top: 0.25rem;
        }

        .cost-info {
            text-align: right;
            min-width: 150px;
            margin-left: 1rem;
        }

        .cost-original {
            font-size: 0.85em;
            color: #666;
        }

        .cost-final {
            font-weight: 600;
            color: #28a745;
            font-size: 1.1em;
        }

        .cost-markup {
            font-size: 0.8em;
            color: #dc3545;
        }

        .resource-content {
            padding: 0 1rem 1rem 1rem;
            border-top: 1px solid #dee2e6;
            background: white;
        }

        .meter-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 0.5rem;
            margin-bottom: 0.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .meter-details {
            flex-grow: 1;
        }

        .meter-name {
            font-weight: 500;
            color: #495057;
        }

        .meter-info {
            font-size: 0.8em;
            color: #6c757d;
        }

        .summary-stats {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .level-1 {
            margin-left: 0;
        }

        .level-2 {
            margin-left: 1rem;
        }

        .level-3 {
            margin-left: 2rem;
        }

        .level-4 {
            margin-left: 3rem;
        }

        /* Removed billing type selection styles - now using automatic detection */
    </style>
</head>

<body>
    <div class="container mt-4">
        <div class="text-center mb-4">
            <h1><i class="fas fa-sitemap me-2"></i>Azure Billing Report Generator</h1>
            <p class="lead">Native HTML hierarchical view with proper resource grouping</p>
        </div>

        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step active" id="step1">
                <i class="fas fa-upload me-2"></i>1. Upload File
            </div>
            <div class="step" id="step2">
                <i class="fas fa-cog me-2"></i>2. Configure
            </div>
            <div class="step" id="step3">
                <i class="fas fa-eye me-2"></i>3. Preview
            </div>
            <div class="step" id="step4">
                <i class="fas fa-magic me-2"></i>4. Generate
            </div>
        </div>

        <!-- Step 1: Upload -->
        <div class="card" id="uploadSection">
            <div class="card-header">
                <h5><i class="fas fa-upload me-2"></i>Step 1: Upload Azure Billing File</h5>
            </div>
            <div class="card-body">
                <!-- Automatic Billing Type Detection (no manual selection needed) -->

                <div class="upload-zone" id="uploadZone">
                    <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-primary"></i>
                    <h4>Drop your billing file here</h4>
                    <p>or click to browse for files</p>
                    <p class="text-muted">Supported formats: .xls, .xlsx, .csv</p>
                </div>
                <input type="file" id="fileInput" accept=".xls,.xlsx,.csv" class="hidden">

                <div class="alert alert-info mt-3" id="sampleDataInfo">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="mb-1"><i class="fas fa-info-circle me-2"></i>Need help with file structure?</h6>
                            <p class="mb-0 small">Download our sample files to see the expected Azure billing data
                                formats. The system will automatically detect your billing type. Supports Excel (.xlsx,
                                .xls) and CSV (.csv) files.</p>
                        </div>
                        <div class="btn-group">
                            <a href="./example/AzureBilling_Sample_Structure.xlsx"
                                download="AzureBilling_Sample_Structure.xlsx" class="btn btn-primary btn-sm">
                                <i class="fas fa-download me-2"></i>Pay-as-you-go Sample
                            </a>
                            <a href="./example/RI_Sample_MockData.xlsx" download="RI_Sample_MockData.xlsx"
                                class="btn btn-primary btn-sm">
                                <i class="fas fa-download me-2"></i>Reserved Instances Sample
                            </a>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">
                            <strong>Pay-as-you-go:</strong> VM with dependencies, resource groups, parent-child
                            relationships •
                            <strong>Reserved Instances:</strong> Customer subscriptions, reserved capacity billing,
                            product SKUs
                        </small>
                    </div>
                </div>

                <div id="uploadProgress" class="mt-3 hidden">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
                    </div>
                </div>

                <div id="fileInfo" class="mt-3 hidden">
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>File uploaded successfully!</strong>
                        <div id="fileDetails"></div>
                    </div>
                    <div class="text-end">
                        <button type="button" class="btn btn-primary" onclick="proceedToConfig()">
                            <i class="fas fa-arrow-right me-2"></i>Configure Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Configure -->
        <div class="card hidden" id="configSection">
            <div class="card-header">
                <h5><i class="fas fa-cog me-2"></i>Step 2: Configure Report Settings</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-6">
                        <h6><i class="fas fa-money-bill-wave me-2"></i>Currency</h6>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            All billing reports use <strong>GBP (£)</strong> as the standard currency.
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <h6><i class="fas fa-percentage me-2"></i>Markup Configuration</h6>
                        <div class="mb-3">
                            <label for="globalMarkup" class="form-label">Global Markup Percentage</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="globalMarkup" value="0" min="0" max="1000"
                                    step="0.1">
                                <span class="input-group-text">%</span>
                            </div>
                            <div class="form-text">Apply this markup to all costs (e.g., 20% for sales margin)</div>
                        </div>

                        <div class="mb-3">
                            <label for="companyName" class="form-label">Company Name (Optional)</label>
                            <input type="text" class="form-control" id="companyName" placeholder="Your Company Name">
                        </div>

                        <div class="mb-3">
                            <label for="reportTitle" class="form-label">Report Title</label>
                            <input type="text" class="form-control" id="reportTitle" value="Azure Billing Report">
                        </div>
                    </div>
                </div>

                <div class="text-end mt-4">
                    <button type="button" class="btn btn-outline-secondary me-2" onclick="backToUpload()">
                        <i class="fas fa-arrow-left me-2"></i>Back to Upload
                    </button>
                    <button type="button" class="btn btn-primary" onclick="proceedToPreview()">
                        <i class="fas fa-arrow-right me-2"></i>Preview Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 3: Preview -->
        <div class="card hidden" id="previewSection">
            <div class="card-header">
                <h5><i class="fas fa-eye me-2"></i>Step 3: Hierarchical Data Preview</h5>
            </div>
            <div class="card-body">
                <div id="previewContent">
                    <!-- Preview content will be populated here -->
                </div>

                <div class="text-end mt-4">
                    <button type="button" class="btn btn-outline-secondary me-2" onclick="backToConfig()">
                        <i class="fas fa-arrow-left me-2"></i>Back to Configuration
                    </button>
                    <button type="button" class="btn btn-primary" onclick="generateReport()">
                        <i class="fas fa-magic me-2"></i>Generate Report
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 4: Generate -->
        <div class="card hidden" id="generateSection">
            <div class="card-header">
                <h5><i class="fas fa-magic me-2"></i>Step 4: Generate Report</h5>
            </div>
            <div class="card-body">
                <div id="generateContent">
                    <!-- Generate content will be populated here -->
                </div>
            </div>
        </div>

        <!-- Report Preview Section -->
        <div class="card hidden mt-4" id="reportPreviewSection">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Hierarchical Report Preview</h5>
                <div>
                    <button type="button" class="btn btn-success btn-sm me-2" onclick="exportReport()">
                        <i class="fas fa-download me-2"></i>Export HTML
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="closeReportPreview()">
                        <i class="fas fa-times me-2"></i>Close Preview
                    </button>
                </div>
            </div>
            <div class="card-body p-3">
                <div id="reportContent" style="max-height: 600px; overflow-y: auto;">
                    <!-- Generated report will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables - simple and clean
        let uploadedData = null;
        let processedData = null;
        let hierarchicalData = null;
        let currentStep = 1;
        let globalMarkupPercent = 0;
        // Fixed currency - always use GBP for all billing reports
        let selectedCurrency = 'GBP';
        let selectedCurrencySymbol = '£';
        let companyName = '';
        let reportTitle = 'Azure Billing Report';
        let selectedBillingType = 'payg'; // 'payg' or 'ri'

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function () {
            setupEventListeners();
        });

        function setupEventListeners() {
            // Removed billing type selection events - now using automatic detection

            // File upload events
            document.getElementById('uploadZone').addEventListener('click', function () {
                document.getElementById('fileInput').click();
            });

            document.getElementById('fileInput').addEventListener('change', handleFileSelect);

            // Drag and drop events
            const uploadZone = document.getElementById('uploadZone');
            uploadZone.addEventListener('dragover', function (e) {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', function (e) {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
            });

            uploadZone.addEventListener('drop', function (e) {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });

            // Markup input
            document.getElementById('globalMarkup').addEventListener('input', function () {
                globalMarkupPercent = parseFloat(this.value) || 0;
            });

            // Company info
            document.getElementById('companyName').addEventListener('input', function () {
                companyName = this.value;
            });

            document.getElementById('reportTitle').addEventListener('input', function () {
                reportTitle = this.value || 'Azure Billing Report';
            });
        }

        // Removed handleBillingTypeChange function - now using automatic detection

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            // Validate file type
            const validTypes = [
                'application/vnd.ms-excel',
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                'text/csv',
                'application/csv'
            ];

            if (!validTypes.includes(file.type) && !file.name.match(/\.(xls|xlsx|csv)$/i)) {
                showError('Please select a valid billing file (.xls, .xlsx, or .csv)');
                return;
            }

            // Show progress
            document.getElementById('uploadProgress').classList.remove('hidden');
            document.querySelector('.progress-bar').style.width = '20%';

            // Determine file type and read accordingly
            const fileExtension = file.name.split('.').pop().toLowerCase();

            if (fileExtension === 'csv') {
                // Handle CSV files
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        document.querySelector('.progress-bar').style.width = '60%';

                        // Parse CSV file
                        const csvText = e.target.result;

                        // Auto-detect delimiter (comma or semicolon)
                        const firstLine = csvText.split('\n')[0];
                        const delimiter = firstLine.includes(';') ? ';' : ',';

                        const parseResult = Papa.parse(csvText, {
                            header: true,
                            delimiter: delimiter,
                            skipEmptyLines: true,
                            transformHeader: function (header) {
                                return header.trim(); // Remove any whitespace from headers
                            }
                        });

                        if (parseResult.errors.length > 0) {
                            console.warn('CSV parsing warnings:', parseResult.errors);
                        }

                        const jsonData = parseResult.data;
                        document.querySelector('.progress-bar').style.width = '100%';

                        // Process the data
                        processUploadedData(jsonData, file);

                    } catch (error) {
                        console.error('Error processing CSV file:', error);
                        showError('Error processing CSV file. Please ensure it\'s a valid CSV file with billing data.');
                        document.getElementById('uploadProgress').classList.add('hidden');
                    }
                };
                reader.readAsText(file);

            } else {
                // Handle Excel files (.xls, .xlsx)
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        document.querySelector('.progress-bar').style.width = '60%';

                        // Parse Excel file
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });

                        // Get first sheet
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];

                        // Convert to JSON with options to handle missing headers
                        const rawData = XLSX.utils.sheet_to_json(worksheet, {
                            header: 1,  // Use first row as headers
                            defval: '',  // Default value for empty cells
                            blankrows: false  // Skip blank rows
                        });

                        let jsonData;

                        // Convert array format to object format manually to ensure all columns are preserved
                        if (rawData.length > 0) {
                            const headers = rawData[0];
                            const rows = rawData.slice(1);

                            jsonData = rows.map(row => {
                                const obj = {};
                                headers.forEach((header, index) => {
                                    // Handle empty or undefined headers
                                    const cleanHeader = header && header.toString().trim() ? header.toString().trim() : `Column_${index}`;
                                    obj[cleanHeader] = row[index] || '';
                                });
                                return obj;
                            });
                        } else {
                            jsonData = rawData;
                        }

                        document.querySelector('.progress-bar').style.width = '100%';

                        // Process the data
                        processUploadedData(jsonData, file);

                    } catch (error) {
                        console.error('Error processing Excel file:', error);
                        showError('Error processing Excel file. Please ensure it\'s a valid Excel file with billing data.');
                        document.getElementById('uploadProgress').classList.add('hidden');
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function detectBillingType(data) {
            if (!data || data.length === 0) return null;

            const firstRow = data[0];
            const columns = Object.keys(firstRow);

            // Normalize column names for comparison (remove extra spaces, handle case variations)
            const normalizedColumns = columns.map(col => col.trim().toLowerCase());

            // Helper function for flexible column matching
            function hasColumn(targetCol) {
                const normalizedTarget = targetCol.toLowerCase();
                return normalizedColumns.some(col =>
                    col === normalizedTarget ||
                    col.includes(normalizedTarget) ||
                    normalizedTarget.includes(col)
                );
            }

            // Pay-as-you-go is characterized by detailed resource-level billing
            // Key indicators: Resource Group + Meter Name + Usage Date (resource-level granularity)
            const paygStrongIndicators = ['Resource Group', 'Meter Name', 'Usage Date'];
            const hasStrongPaygIndicators = paygStrongIndicators.every(col => hasColumn(col));

            // Additional PayG supporting columns
            const paygSupportingColumns = ['Total Cost', 'Tags', 'Meter Id', 'Product Name', 'Quantity'];
            const hasPaygSupporting = paygSupportingColumns.some(col => hasColumn(col));

            // Reserved Instances is characterized by subscription-level billing without resource details
            // Key indicators: Must have RI-specific columns AND lack detailed resource metering
            const riSpecificColumns = ['Sub Total', 'Billing Period', 'Sku Name'];
            const hasRiSpecific = riSpecificColumns.some(col => hasColumn(col));

            // Customer/Subscription columns can appear in both types, so they're not decisive

            // Decision logic: Prioritize resource-level granularity for PayG detection
            if (hasStrongPaygIndicators && hasPaygSupporting) {
                return 'payg';  // Strong PayG indicators take precedence
            } else if (hasRiSpecific && !hasStrongPaygIndicators) {
                return 'ri';    // RI-specific columns without resource-level detail
            } else if (hasStrongPaygIndicators) {
                return 'payg';  // Resource-level detail indicates PayG
            } else if (hasRiSpecific) {
                return 'ri';    // RI-specific columns
            }

            return null; // Cannot determine
        }

        function processUploadedData(data, file) {
            uploadedData = data;

            // Validate data structure
            if (!data || data.length === 0) {
                showError('The uploaded file appears to be empty or invalid.');
                return;
            }

            // Automatically detect billing type from data structure
            const detectedBillingType = detectBillingType(data);
            if (detectedBillingType) {
                selectedBillingType = detectedBillingType;
            } else {
                showError('Unable to determine billing type. Please ensure your file contains the expected Azure billing structure.');
                return;
            }

            // Process data based on billing type
            if (selectedBillingType === 'payg') {
                // Fix Usage Date format and calculate costs for Pay-as-you-go data
                uploadedData = uploadedData.map(row => {
                    if (row['Usage Date']) {
                        // Handle Excel date serial numbers and various date formats
                        let usageDate = row['Usage Date'];
                        if (typeof usageDate === 'number') {
                            // Excel date serial number conversion
                            const excelEpoch = new Date(1900, 0, 1);
                            usageDate = new Date(excelEpoch.getTime() + (usageDate - 2) * 24 * 60 * 60 * 1000);
                        }
                        row['Usage Date'] = formatDate(usageDate);
                    }

                    // Store original cost for later calculation
                    row['Original Cost'] = parseFloat(row['Total Cost']) || 0;

                    return row;
                });
            } else {
                // Process Reserved Instances data - normalize date fields and calculate costs
                uploadedData = uploadedData.map(row => {
                    // Normalize billing period and subscription dates
                    if (row['Billing Period']) {
                        row['Billing Period'] = formatDate(row['Billing Period']);
                    }
                    if (row['Subscription StartDate']) {
                        row['Subscription StartDate'] = formatDate(row['Subscription StartDate']);
                    }
                    if (row['Subscription EndDate']) {
                        row['Subscription EndDate'] = formatDate(row['Subscription EndDate']);
                    }

                    // Store original cost for later calculation (RI uses 'Sub Total' instead of 'Total Cost')
                    row['Original Cost'] = parseFloat(row['Sub Total']) || 0;

                    return row;
                });
            }

            // Show file info with auto-detected billing type
            const billingTypeLabel = selectedBillingType === 'payg' ? 'Pay-as-you-go' : 'Reserved Instances';
            document.getElementById('fileDetails').innerHTML = `
                <div class="mt-2">
                    <strong>File:</strong> ${file.name}<br>
                    <strong>Size:</strong> ${(file.size / 1024).toFixed(1)} KB<br>
                    <strong>Records:</strong> ${data.length.toLocaleString()}<br>
                    <strong>Auto-detected Type:</strong> ${billingTypeLabel}<br>
                    <strong>Currency:</strong> ${selectedCurrency} (${selectedCurrencySymbol})
                </div>
            `;

            document.getElementById('fileInfo').classList.remove('hidden');
            document.getElementById('uploadProgress').classList.add('hidden');
        }

        function formatDate(date) {
            if (!date) return 'N/A';
            if (typeof date === 'string') return date;

            try {
                const d = new Date(date);
                if (isNaN(d.getTime())) return 'N/A';
                return d.toISOString().split('T')[0]; // YYYY-MM-DD format
            } catch (e) {
                return 'N/A';
            }
        }

        // Removed autoDetectCurrency function - now using fixed GBP currency

        // Removed selectCurrency function - now using fixed GBP currency

        // Navigation functions
        function proceedToConfig() {
            if (!uploadedData) {
                showError('Please upload a file first.');
                return;
            }
            currentStep = 2;
            updateStepIndicator();
            showSection('configSection');
        }

        function backToUpload() {
            currentStep = 1;
            updateStepIndicator();
            showSection('uploadSection');
        }

        function proceedToPreview() {
            if (!uploadedData) {
                showError('Please upload a file first.');
                return;
            }

            // Process data with markup based on billing type
            processedData = uploadedData.map(row => {
                // Use the correct cost field based on billing type
                let originalCost;
                if (selectedBillingType === 'payg') {
                    originalCost = parseFloat(row['Total Cost']) || 0;
                } else {
                    originalCost = parseFloat(row['Sub Total']) || 0;
                }

                const markupAmount = originalCost * (globalMarkupPercent / 100);
                const finalCost = originalCost + markupAmount;
                return {
                    ...row,
                    'Original Cost': originalCost,
                    'Markup Amount': markupAmount,
                    'Final Cost': finalCost
                };
            });

            // Create hierarchical structure using proper Azure resource relationships
            hierarchicalData = createHierarchicalStructure(processedData);

            // Generate preview
            generateHierarchicalPreview();

            currentStep = 3;
            updateStepIndicator();
            showSection('previewSection');
        }

        function backToConfig() {
            currentStep = 2;
            updateStepIndicator();
            showSection('configSection');
        }

        function createHierarchicalStructure(data) {
            if (selectedBillingType === 'payg') {
                return createPaygHierarchy(data);
            } else {
                return createRiHierarchy(data);
            }
        }

        function createPaygHierarchy(data) {
            const hierarchy = {};

            // Group by Resource Group for Pay-as-you-go
            data.forEach(row => {
                const resourceGroup = row['Resource Group'] || 'Unknown Resource Group';
                const resourceName = row['Resource Name'] || 'Unknown Resource';
                const productName = row['Product Name'] || 'Unknown Product';
                const meterName = row['Meter Name'] || 'Unknown Meter';
                const tags = row['Tags'] || '';

                // Initialize resource group
                if (!hierarchy[resourceGroup]) {
                    hierarchy[resourceGroup] = {
                        name: resourceGroup,
                        type: 'Resource Group',
                        resources: {},
                        totalCost: 0,
                        totalOriginalCost: 0,
                        totalMarkupAmount: 0,
                        itemCount: 0
                    };
                }

                // Initialize resource within group
                if (!hierarchy[resourceGroup].resources[resourceName]) {
                    hierarchy[resourceGroup].resources[resourceName] = {
                        name: resourceName,
                        type: getResourceType(productName, meterName),
                        products: {},
                        totalCost: 0,
                        totalOriginalCost: 0,
                        totalMarkupAmount: 0,
                        itemCount: 0,
                        tags: tags,
                        parentResource: extractParentResource(tags)
                    };
                }

                // Initialize product within resource
                const productKey = `${productName}_${meterName}`;
                if (!hierarchy[resourceGroup].resources[resourceName].products[productKey]) {
                    hierarchy[resourceGroup].resources[resourceName].products[productKey] = {
                        name: productName,
                        meterName: meterName,
                        type: 'Product/Meter',
                        items: [],
                        totalCost: 0,
                        totalOriginalCost: 0,
                        totalMarkupAmount: 0,
                        itemCount: 0
                    };
                }

                // Calculate costs with current markup
                const originalCost = row['Original Cost'];
                const markupAmount = originalCost * (globalMarkupPercent / 100);
                const finalCost = originalCost + markupAmount;

                // Add the individual item
                const product = hierarchy[resourceGroup].resources[resourceName].products[productKey];
                product.items.push({
                    usageDate: row['Usage Date'],
                    quantity: row['Quantity'],
                    unitPrice: row['Unit Price'],
                    originalCost: originalCost,
                    markupAmount: markupAmount,
                    finalCost: finalCost,
                    meterRegion: row['Meter Region']
                });

                // Update totals at all levels

                product.totalOriginalCost += originalCost;
                product.totalMarkupAmount += markupAmount;
                product.totalCost += finalCost;
                product.itemCount += 1;

                const resource = hierarchy[resourceGroup].resources[resourceName];
                resource.totalOriginalCost += originalCost;
                resource.totalMarkupAmount += markupAmount;
                resource.totalCost += finalCost;
                resource.itemCount += 1;

                hierarchy[resourceGroup].totalOriginalCost += originalCost;
                hierarchy[resourceGroup].totalMarkupAmount += markupAmount;
                hierarchy[resourceGroup].totalCost += finalCost;
                hierarchy[resourceGroup].itemCount += 1;
            });

            return hierarchy;
        }

        function createRiHierarchy(data) {
            const hierarchy = {};

            // Group by Customer → Product for Reserved Instances
            data.forEach(row => {
                const customerName = row['Customer Name'] || 'Unknown Customer';
                const subscriptionId = row['Subscription Id'] || 'Unknown Subscription';
                const productName = row['Product Name'] || 'Unknown Product';
                const skuName = row['Sku Name'] || 'Unknown SKU';
                const billingPeriod = row['Billing Period'] || 'Unknown Period';

                // Initialize customer
                if (!hierarchy[customerName]) {
                    hierarchy[customerName] = {
                        name: customerName,
                        type: 'Customer',
                        resources: {},
                        totalCost: 0,
                        totalOriginalCost: 0,
                        totalMarkupAmount: 0,
                        itemCount: 0
                    };
                }

                // Initialize product within customer (group by product name)
                const productKey = productName;
                if (!hierarchy[customerName].resources[productKey]) {
                    hierarchy[customerName].resources[productKey] = {
                        name: productName,
                        meterName: skuName,
                        type: 'Reserved Instance',
                        items: [],
                        totalCost: 0,
                        totalOriginalCost: 0,
                        totalMarkupAmount: 0,
                        itemCount: 0
                    };
                }

                // Calculate costs with current markup
                const originalCost = row['Sub Total'] || row['Original Cost'] || 0;
                const markupAmount = originalCost * (globalMarkupPercent / 100);
                const finalCost = originalCost + markupAmount;

                // Add the individual reservation item with subscription context
                const product = hierarchy[customerName].resources[productKey];
                product.items.push({
                    usageDate: billingPeriod,
                    quantity: row['Quantity'],
                    unitPrice: row['Unit Price'],
                    originalCost: originalCost,
                    markupAmount: markupAmount,
                    finalCost: finalCost,
                    meterRegion: 'Reserved Instance',
                    subscriptionId: subscriptionId,
                    subscriptionStartDate: row['Subscription StartDate'],
                    subscriptionEndDate: row['Subscription EndDate'],
                    customerId: row['CustomerId'],
                    publisherName: row['Publisher Name'],
                    productCategory: row['Product Category'],
                    skuName: skuName
                });

                // Update totals at product level
                product.totalOriginalCost += originalCost;
                product.totalMarkupAmount += markupAmount;
                product.totalCost += finalCost;
                product.itemCount += 1;

                // Update totals at customer level
                hierarchy[customerName].totalOriginalCost += originalCost;
                hierarchy[customerName].totalMarkupAmount += markupAmount;
                hierarchy[customerName].totalCost += finalCost;
                hierarchy[customerName].itemCount += 1;
            });

            return hierarchy;
        }

        function getResourceType(productName, meterName) {
            if (productName.includes('Virtual Machine') || meterName.includes('VM')) return 'Virtual Machine';
            if (productName.includes('Disk') || meterName.includes('Disk')) return 'Storage Disk';
            if (productName.includes('Backup') || meterName.includes('Backup')) return 'Backup Service';
            if (productName.includes('Network') || meterName.includes('Network')) return 'Network Service';
            if (productName.includes('Storage') || meterName.includes('Storage')) return 'Storage Service';
            return 'Azure Service';
        }

        function extractParentResource(tags) {
            if (!tags) return null;
            const match = tags.match(/cm-resource-parent[:\s]*([^,;]+)/i);
            return match ? match[1].trim() : null;
        }

        function generateHierarchicalPreview() {
            const totalOriginal = Object.values(hierarchicalData).reduce((sum, rg) => sum + rg.totalOriginalCost, 0);
            const totalMarkup = Object.values(hierarchicalData).reduce((sum, rg) => sum + rg.totalMarkupAmount, 0);
            const totalFinal = Object.values(hierarchicalData).reduce((sum, rg) => sum + rg.totalCost, 0);
            const totalRecords = processedData.length;

            const previewHtml = `
                <div class="summary-stats">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-value">${totalRecords.toLocaleString()}</div>
                                <div class="stat-label">Total Records</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-value">${selectedCurrencySymbol}${totalOriginal.toFixed(2)}</div>
                                <div class="stat-label">Original Cost</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-value">${selectedCurrencySymbol}${totalMarkup.toFixed(2)}</div>
                                <div class="stat-label">Markup Amount</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-value">${selectedCurrencySymbol}${totalFinal.toFixed(2)}</div>
                                <div class="stat-label">Final Cost</div>
                            </div>
                        </div>
                    </div>
                </div>

                <h6><i class="fas fa-sitemap me-2"></i>Hierarchical Resource View</h6>
                <p class="text-muted mb-3">Click on items to expand/collapse and view dependencies</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Account Manager Preview:</strong> This preview shows markup details for internal use. The final customer report will only show final costs without markup information.
                </div>

                <div class="resource-hierarchy">
                    ${generateNativeTreeHTML(hierarchicalData)}
                </div>
            `;

            document.getElementById('previewContent').innerHTML = previewHtml;
        }

        function generateNativeTreeHTML(hierarchy) {
            let html = '';

            Object.values(hierarchy).forEach(topLevel => {
                const hasChildren = Object.keys(topLevel.resources).length > 0;
                const topLevelIcon = selectedBillingType === 'payg' ? 'fas fa-folder' : 'fas fa-user';
                const childrenLabel = selectedBillingType === 'payg' ? 'resources' : 'products';

                html += `
                    <details class="level-1">
                        <summary>
                            <div class="resource-info">
                                <div class="resource-details">
                                    <div class="resource-name">
                                        <i class="${topLevelIcon} me-2"></i>${topLevel.name}
                                    </div>
                                    <div class="resource-type">${topLevel.type} • ${Object.keys(topLevel.resources).length} ${childrenLabel} • ${topLevel.itemCount} billing items</div>
                                </div>
                                <div class="cost-info">
                                    <div class="cost-original">Original: ${selectedCurrencySymbol}${topLevel.totalOriginalCost.toFixed(2)}</div>
                                    <div class="cost-final">${selectedCurrencySymbol}${topLevel.totalCost.toFixed(2)}</div>
                                    <div class="cost-markup">+${selectedCurrencySymbol}${topLevel.totalMarkupAmount.toFixed(2)}</div>
                                </div>
                            </div>
                        </summary>
                        ${hasChildren ? `<div class="resource-content">${generateResourcesHTML(topLevel.resources)}</div>` : ''}
                    </details>
                `;
            });

            return html;
        }

        function generateResourcesHTML(resources) {
            let html = '';

            Object.values(resources).forEach(resource => {
                // For new RI structure, resources ARE products (no intermediate subscription level)
                // For PayG structure, resources have products
                const hasChildren = resource.products ? Object.keys(resource.products).length > 0 : resource.items && resource.items.length > 0;
                const resourceIcon = getResourceIcon(resource.type);

                // Different display for RI vs Pay-as-you-go
                let resourceDetails = '';
                if (selectedBillingType === 'ri') {
                    // New RI structure: resource IS the product
                    resourceDetails = `
                        <div class="resource-type">${resource.type}, ${resource.meterName || 'Unknown SKU'} • ${resource.itemCount} reservations</div>
                    `;
                } else {
                    // PayG structure: resource has products
                    resourceDetails = `
                        <div class="resource-type">${resource.type} • ${Object.keys(resource.products || {}).length} products • ${resource.itemCount} billing items</div>
                        ${resource.parentResource ? `<div class="resource-type"><small>Parent: ${resource.parentResource}</small></div>` : ''}
                    `;
                }

                html += `
                    <details class="level-2">
                        <summary>
                            <div class="resource-info">
                                <div class="resource-details">
                                    <div class="resource-name">
                                        <i class="${resourceIcon} me-2"></i>${resource.name}
                                    </div>
                                    ${resourceDetails}
                                </div>
                                <div class="cost-info">
                                    <div class="cost-original">Original: ${selectedCurrencySymbol}${resource.totalOriginalCost.toFixed(2)}</div>
                                    <div class="cost-final">${selectedCurrencySymbol}${resource.totalCost.toFixed(2)}</div>
                                    <div class="cost-markup">+${selectedCurrencySymbol}${resource.totalMarkupAmount.toFixed(2)}</div>
                                </div>
                            </div>
                        </summary>
                        ${hasChildren ? `<div class="resource-content">${selectedBillingType === 'ri' ? generateItemsHTML(resource.items) : generateProductsHTML(resource.products)}</div>` : ''}
                    </details>
                `;
            });

            return html;
        }

        function generateProductsHTML(products) {
            let html = '';

            Object.values(products).forEach(product => {
                const hasChildren = product.items.length > 0;

                html += `
                    <details class="level-3">
                        <summary>
                            <div class="resource-info">
                                <div class="resource-details">
                                    <div class="resource-name">
                                        <i class="fas fa-cube me-2"></i>${product.name}
                                    </div>
                                    <div class="resource-type">${product.meterName} • ${product.items.length} usage records</div>
                                </div>
                                <div class="cost-info">
                                    <div class="cost-original">Original: ${selectedCurrencySymbol}${product.totalOriginalCost.toFixed(2)}</div>
                                    <div class="cost-final">${selectedCurrencySymbol}${product.totalCost.toFixed(2)}</div>
                                    <div class="cost-markup">+${selectedCurrencySymbol}${product.totalMarkupAmount.toFixed(2)}</div>
                                </div>
                            </div>
                        </summary>
                        ${hasChildren ? `<div class="resource-content">${generateItemsHTML(product.items)}</div>` : ''}
                    </details>
                `;
            });

            return html;
        }

        function generateItemsHTML(items) {
            let html = '';

            items.forEach((item, index) => {
                // For RI items, show subscription context; for PayG items, show usage date
                const itemTitle = item.subscriptionId
                    ? `Reservation ${index + 1}`
                    : `Usage: ${item.usageDate}`;

                const itemInfo = item.subscriptionId
                    ? `Qty: ${item.quantity} @ ${selectedCurrencySymbol}${(parseFloat(item.unitPrice) || 0).toFixed(4)} | Subscription: ${item.subscriptionId.substring(0, 8)}...`
                    : `Qty: ${item.quantity} @ ${selectedCurrencySymbol}${(parseFloat(item.unitPrice) || 0).toFixed(4)} | Region: ${item.meterRegion || 'N/A'}`;

                html += `
                    <div class="meter-item level-4">
                        <div class="meter-details">
                            <div class="meter-name">${itemTitle}</div>
                            <div class="meter-info">${itemInfo}</div>
                        </div>
                        <div class="cost-info">
                            <div class="cost-original">Original: ${selectedCurrencySymbol}${item.originalCost.toFixed(2)}</div>
                            <div class="cost-final">${selectedCurrencySymbol}${item.finalCost.toFixed(2)}</div>
                            <div class="cost-markup">+${selectedCurrencySymbol}${item.markupAmount.toFixed(2)}</div>
                        </div>
                    </div>
                `;
            });

            return html;
        }

        function getResourceIcon(resourceType) {
            switch (resourceType) {
                case 'Virtual Machine': return 'fas fa-server';
                case 'Storage Disk': return 'fas fa-hdd';
                case 'Backup Service': return 'fas fa-shield-alt';
                case 'Network Service': return 'fas fa-network-wired';
                case 'Storage Service': return 'fas fa-database';
                case 'Subscription': return 'fas fa-credit-card';
                case 'Customer': return 'fas fa-user';
                default: return 'fas fa-cube';
            }
        }

        // Customer-facing tree HTML (no markup information)
        function generateCustomerTreeHTML(hierarchy) {
            let html = '';

            Object.values(hierarchy).forEach(topLevel => {
                const hasChildren = Object.keys(topLevel.resources).length > 0;
                const topLevelIcon = selectedBillingType === 'payg' ? 'fas fa-folder' : 'fas fa-user';
                const childrenLabel = selectedBillingType === 'payg' ? 'resources' : 'products';

                html += `
                    <details class="level-1">
                        <summary>
                            <div class="resource-info">
                                <div class="resource-details">
                                    <div class="resource-name">
                                        <i class="${topLevelIcon} me-2"></i>${topLevel.name}
                                    </div>
                                    <div class="resource-type">${topLevel.type} • ${Object.keys(topLevel.resources).length} ${childrenLabel} • ${topLevel.itemCount} billing items</div>
                                </div>
                                <div class="cost-info">
                                    <div class="cost-final">${selectedCurrencySymbol}${topLevel.totalCost.toFixed(2)}</div>
                                </div>
                            </div>
                        </summary>
                        ${hasChildren ? `<div class="resource-content">${generateCustomerResourcesHTML(topLevel.resources)}</div>` : ''}
                    </details>
                `;
            });

            return html;
        }

        function generateCustomerResourcesHTML(resources) {
            let html = '';

            Object.values(resources).forEach(resource => {
                // For new RI structure, resources ARE products (no intermediate subscription level)
                // For PayG structure, resources have products
                const hasChildren = resource.products ? Object.keys(resource.products).length > 0 : resource.items && resource.items.length > 0;
                const resourceIcon = getResourceIcon(resource.type);

                // Different display for RI vs Pay-as-you-go
                let resourceDetails = '';
                if (selectedBillingType === 'ri') {
                    // New RI structure: resource IS the product
                    resourceDetails = `
                        <div class="resource-type">${resource.type}, ${resource.meterName || 'Unknown SKU'} • ${resource.itemCount} reservations</div>
                    `;
                } else {
                    // PayG structure: resource has products
                    resourceDetails = `
                        <div class="resource-type">${resource.type} • ${Object.keys(resource.products || {}).length} products • ${resource.itemCount} billing items</div>
                        ${resource.parentResource ? `<div class="resource-type"><small>Parent: ${resource.parentResource}</small></div>` : ''}
                    `;
                }

                html += `
                    <details class="level-2">
                        <summary>
                            <div class="resource-info">
                                <div class="resource-details">
                                    <div class="resource-name">
                                        <i class="${resourceIcon} me-2"></i>${resource.name}
                                    </div>
                                    ${resourceDetails}
                                </div>
                                <div class="cost-info">
                                    <div class="cost-final">${selectedCurrencySymbol}${resource.totalCost.toFixed(2)}</div>
                                </div>
                            </div>
                        </summary>
                        ${hasChildren ? `<div class="resource-content">${selectedBillingType === 'ri' ? generateCustomerItemsHTML(resource.items) : generateCustomerProductsHTML(resource.products)}</div>` : ''}
                    </details>
                `;
            });

            return html;
        }

        function generateCustomerProductsHTML(products) {
            let html = '';

            Object.values(products).forEach(product => {
                const hasChildren = product.items.length > 0;

                html += `
                    <details class="level-3">
                        <summary>
                            <div class="resource-info">
                                <div class="resource-details">
                                    <div class="resource-name">
                                        <i class="fas fa-cube me-2"></i>${product.name}
                                    </div>
                                    <div class="resource-type">${product.meterName} • ${product.items.length} usage records</div>
                                </div>
                                <div class="cost-info">
                                    <div class="cost-final">${selectedCurrencySymbol}${product.totalCost.toFixed(2)}</div>
                                </div>
                            </div>
                        </summary>
                        ${hasChildren ? `<div class="resource-content">${generateCustomerItemsHTML(product.items)}</div>` : ''}
                    </details>
                `;
            });

            return html;
        }

        function generateCustomerItemsHTML(items) {
            let html = '';

            items.forEach((item, index) => {
                // For RI items, show subscription context; for PayG items, show usage date
                const itemTitle = item.subscriptionId
                    ? `Reservation ${index + 1}`
                    : `Usage: ${item.usageDate}`;

                const itemInfo = item.subscriptionId
                    ? `Qty: ${item.quantity} @ ${selectedCurrencySymbol}${(parseFloat(item.unitPrice) || 0).toFixed(4)} | Subscription: ${item.subscriptionId.substring(0, 8)}...`
                    : `Qty: ${item.quantity} @ ${selectedCurrencySymbol}${(parseFloat(item.unitPrice) || 0).toFixed(4)} | Region: ${item.meterRegion || 'N/A'}`;

                html += `
                    <div class="meter-item level-4">
                        <div class="meter-details">
                            <div class="meter-name">${itemTitle}</div>
                            <div class="meter-info">${itemInfo}</div>
                        </div>
                        <div class="cost-info">
                            <div class="cost-final">${selectedCurrencySymbol}${item.finalCost.toFixed(2)}</div>
                        </div>
                    </div>
                `;
            });

            return html;
        }

        function generateReport() {
            if (!hierarchicalData) {
                showError('Please process the data first.');
                return;
            }

            currentStep = 4;
            updateStepIndicator();
            showSection('generateSection');

            // Show loading
            document.getElementById('generateContent').innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5>Generating Hierarchical Report...</h5>
                    <p class="text-muted">Processing ${processedData.length.toLocaleString()} records</p>
                </div>
            `;

            // Simulate processing time
            setTimeout(() => {
                document.getElementById('generateContent').innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>Report Generated Successfully!</strong>
                        <p class="mb-0 mt-2">Your hierarchical Azure billing report is ready for preview and export.</p>
                    </div>

                    <div class="d-flex gap-2 justify-content-center flex-wrap">
                        <button type="button" class="btn btn-primary" onclick="previewReport()">
                            <i class="fas fa-eye me-2"></i>Preview Report
                        </button>
                        <button type="button" class="btn btn-success" onclick="exportReport()">
                            <i class="fas fa-download me-2"></i>Export HTML
                        </button>
                        <button type="button" class="btn btn-info" onclick="showIndividualCustomerReports()">
                            <i class="fas fa-users me-2"></i>Individual Customer Reports
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="startOver()">
                            <i class="fas fa-redo me-2"></i>Start Over
                        </button>
                    </div>
                `;
            }, 2000);
        }

        function previewReport() {
            const reportHtml = generateReportHTML();
            document.getElementById('reportContent').innerHTML = reportHtml;
            document.getElementById('reportPreviewSection').classList.remove('hidden');
            document.getElementById('reportPreviewSection').classList.add('fade-in');
            document.getElementById('reportPreviewSection').scrollIntoView({ behavior: 'smooth' });
        }

        function generateReportHTML() {
            const totalOriginal = Object.values(hierarchicalData).reduce((sum, rg) => sum + rg.totalOriginalCost, 0);
            const totalMarkup = Object.values(hierarchicalData).reduce((sum, rg) => sum + rg.totalMarkupAmount, 0);
            const totalFinal = Object.values(hierarchicalData).reduce((sum, rg) => sum + rg.totalCost, 0);
            const totalRecords = processedData.length;
            const currentDate = new Date().toLocaleDateString();

            return `
                <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px;">
                    <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #007bff; padding-bottom: 20px;">
                        <h1 style="color: #333; margin-bottom: 10px;">
                            <i class="fas fa-sitemap" style="margin-right: 10px;"></i>${reportTitle}
                        </h1>
                        ${companyName ? `<h2 style="color: #666; font-weight: 300;">${companyName}</h2>` : ''}
                        <p style="color: #666; margin: 0;">Generated on ${currentDate}</p>
                    </div>

                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px; padding: 20px; margin-bottom: 30px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 15px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 600;">${totalRecords.toLocaleString()}</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Total Billing Records</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 15px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 600;">${Object.keys(hierarchicalData).length}</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Resource Groups</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 15px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 600;">${selectedCurrencySymbol}${totalFinal.toFixed(2)}</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Total Cost</div>
                            </div>
                        </div>
                    </div>

                    <h3 style="color: #333; margin-bottom: 15px;">
                        <i class="fas fa-sitemap" style="margin-right: 10px;"></i>Hierarchical Resource Breakdown
                    </h3>
                    <p style="color: #666; margin-bottom: 20px;">Native HTML collapsible interface - click to expand/collapse resource dependencies</p>

                    <div class="resource-hierarchy">
                        ${generateCustomerTreeHTML(hierarchicalData)}
                    </div>

                    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #dee2e6; text-align: center; color: #666; font-size: 0.9rem;">
                        <p>Report generated by Azure Billing Report Generator</p>
                        <p>Currency: ${selectedCurrency} (${selectedCurrencySymbol})</p>
                        <p>Professional Azure billing analysis and reporting</p>
                    </div>
                </div>
            `;
        }

        function exportReport() {
            if (!hierarchicalData) {
                showError('No report data available to export.');
                return;
            }

            const reportHtml = generateStandaloneReportHTML();
            const blob = new Blob([reportHtml], { type: 'text/html' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `Azure_Billing_Hierarchical_Report_${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function generateStandaloneReportHTML() {
            const reportContent = generateReportHTML();

            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${reportTitle} - ${companyName || 'Azure Billing Report'}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .resource-hierarchy { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        details { border: 1px solid #dee2e6; border-radius: 6px; margin-bottom: 0.5rem; background: #f8f9fa; }
        details[open] { background: #e3f2fd; border-color: #007bff; }
        summary { padding: 0.75rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; transition: all 0.3s; }
        summary:hover { background: rgba(0,123,255,0.1); }
        .resource-info { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .resource-details { flex-grow: 1; }
        .resource-name { font-weight: 600; color: #333; }
        .resource-type { font-size: 0.85em; color: #666; margin-top: 0.25rem; }
        .cost-info { text-align: right; min-width: 150px; margin-left: 1rem; }
        .cost-original { font-size: 0.85em; color: #666; }
        .cost-final { font-weight: 600; color: #28a745; font-size: 1.1em; }
        .cost-markup { font-size: 0.8em; color: #dc3545; }
        .resource-content { padding: 0 1rem 1rem 1rem; border-top: 1px solid #dee2e6; background: white; }
        .meter-item { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; padding: 0.5rem; margin-bottom: 0.25rem; display: flex; justify-content: space-between; align-items: center; }
        .meter-details { flex-grow: 1; }
        .meter-name { font-weight: 500; color: #495057; }
        .meter-info { font-size: 0.8em; color: #6c757d; }
        .level-1 { margin-left: 0; }
        .level-2 { margin-left: 1rem; }
        .level-3 { margin-left: 2rem; }
        .level-4 { margin-left: 3rem; }
    </style>
</head>
<body>
    ${reportContent}
</body>
</html>`;
        }

        function closeReportPreview() {
            document.getElementById('reportPreviewSection').classList.add('hidden');
        }

        function startOver() {
            // Reset all data
            uploadedData = null;
            processedData = null;
            hierarchicalData = null;
            currentStep = 1;
            globalMarkupPercent = 0;
            selectedCurrency = 'GBP';
            selectedCurrencySymbol = '£';
            companyName = '';
            reportTitle = 'Azure Billing Report';

            // Reset form inputs
            document.getElementById('fileInput').value = '';
            document.getElementById('globalMarkup').value = '0';
            document.getElementById('companyName').value = '';
            document.getElementById('reportTitle').value = 'Azure Billing Report';

            // Currency is fixed to GBP - no reset needed

            // Hide all sections except upload
            document.querySelectorAll('.card').forEach(card => card.classList.add('hidden'));
            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('reportPreviewSection').classList.add('hidden');

            // Reset step indicator
            updateStepIndicator();
        }

        function updateStepIndicator() {
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active', 'completed');
            });

            for (let i = 1; i <= 4; i++) {
                const step = document.getElementById(`step${i}`);
                if (i < currentStep) {
                    step.classList.add('completed');
                } else if (i === currentStep) {
                    step.classList.add('active');
                }
            }
        }

        function showSection(sectionId) {
            document.querySelectorAll('.card').forEach(card => card.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
            document.getElementById(sectionId).classList.add('fade-in');
        }

        function showError(message) {
            // Create or update error alert
            let errorAlert = document.getElementById('errorAlert');
            if (!errorAlert) {
                errorAlert = document.createElement('div');
                errorAlert.id = 'errorAlert';
                errorAlert.className = 'alert alert-danger alert-dismissible fade show';
                errorAlert.setAttribute('role', 'alert');
                errorAlert.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="errorMessage"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                document.querySelector('.container').prepend(errorAlert);
            }

            document.getElementById('errorMessage').textContent = message;
            errorAlert.classList.remove('hidden');
            errorAlert.classList.add('fade-in');

            // Auto-hide after 5 seconds
            setTimeout(() => {
                errorAlert.style.display = 'none';
            }, 5000);
        }

        // Individual Customer Reports Functions
        function showIndividualCustomerReports() {
            if (!hierarchicalData) {
                showError('Please process the data first.');
                return;
            }

            // Get list of customers
            const customers = Object.keys(hierarchicalData);

            if (customers.length === 0) {
                showError('No customers found in the data.');
                return;
            }

            // Show the individual reports section
            document.getElementById('individualReportsSection').classList.remove('hidden');
            document.getElementById('individualReportsSection').classList.add('fade-in');

            // Generate customer selection interface
            let html = `
                <div class="mb-4">
                    <h6><i class="fas fa-info-circle me-2"></i>Select Customers for Individual Reports</h6>
                    <p class="text-muted">Choose which customers you want to generate individual reports for. Each customer will get their own HTML report file.</p>
                </div>

                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">Available Customers (${customers.length})</h6>
                                <div>
                                    <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="selectAllCustomers()">
                                        <i class="fas fa-check-square me-1"></i>Select All
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllCustomers()">
                                        <i class="fas fa-square me-1"></i>Deselect All
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
            `;

            customers.forEach((customerName, index) => {
                const customer = hierarchicalData[customerName];
                const resourceCount = Object.keys(customer.resources).length;
                const itemCount = customer.itemCount;

                html += `
                    <div class="col-md-6 mb-3">
                        <div class="form-check">
                            <input class="form-check-input customer-checkbox" type="checkbox" value="${customerName}" id="customer_${index}" checked>
                            <label class="form-check-label" for="customer_${index}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <strong>${customerName}</strong>
                                        <br>
                                        <small class="text-muted">
                                            ${resourceCount} ${selectedBillingType === 'payg' ? 'resources' : 'products'} • ${itemCount} items • ${selectedCurrencySymbol}${customer.totalCost.toFixed(2)}
                                        </small>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                `;
            });

            html += `
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-download me-2"></i>Generate Reports</h6>
                            </div>
                            <div class="card-body text-center">
                                <p class="text-muted small mb-3">Selected customers will be exported as individual HTML reports in a ZIP file.</p>
                                <button type="button" class="btn btn-success" onclick="generateIndividualReports()">
                                    <i class="fas fa-file-archive me-2"></i>Download ZIP
                                </button>
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <i class="fas fa-shield-alt me-1"></i>
                                        Customer reports hide markup information
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('individualReportsContent').innerHTML = html;
            document.getElementById('individualReportsSection').scrollIntoView({ behavior: 'smooth' });
        }

        function selectAllCustomers() {
            document.querySelectorAll('.customer-checkbox').forEach(checkbox => {
                checkbox.checked = true;
            });
        }

        function deselectAllCustomers() {
            document.querySelectorAll('.customer-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        function closeIndividualReports() {
            document.getElementById('individualReportsSection').classList.add('hidden');
        }

        async function generateIndividualReports() {
            // Get selected customers
            const selectedCustomers = [];
            document.querySelectorAll('.customer-checkbox:checked').forEach(checkbox => {
                selectedCustomers.push(checkbox.value);
            });

            if (selectedCustomers.length === 0) {
                showError('Please select at least one customer.');
                return;
            }

            // Show loading state
            const generateBtn = document.querySelector('button[onclick="generateIndividualReports()"]');
            const originalText = generateBtn.innerHTML;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
            generateBtn.disabled = true;

            try {
                // Create ZIP file
                const zip = new JSZip();

                // Generate report for each selected customer
                for (const customerName of selectedCustomers) {
                    const customerHierarchy = {
                        [customerName]: hierarchicalData[customerName]
                    };

                    const customerReportHTML = generateCustomerReportHTML(customerHierarchy, customerName);
                    const fileName = `${customerName.replace(/[^a-zA-Z0-9]/g, '_')}_Azure_Billing_Report.html`;
                    zip.file(fileName, customerReportHTML);
                }

                // Generate ZIP and download
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Azure_Individual_Customer_Reports_${new Date().toISOString().split('T')[0]}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // Show success message
                showSuccess(`Successfully generated ${selectedCustomers.length} individual customer reports!`);

            } catch (error) {
                console.error('Error generating individual reports:', error);
                showError('Failed to generate individual reports. Please try again.');
            } finally {
                // Restore button
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;
            }
        }

        function generateCustomerReportHTML(customerHierarchy, customerName) {
            const customer = customerHierarchy[customerName];
            const totalRecords = customer.itemCount;
            const totalCost = customer.totalCost;
            const currentDate = new Date().toLocaleDateString();
            const resourceCount = Object.keys(customer.resources).length;

            return `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${customerName} - Azure Billing Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .resource-hierarchy { margin-top: 20px; }
        .level-1, .level-2, .level-3 { margin-bottom: 10px; }
        .level-1 > summary { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6; }
        .level-2 > summary { background: #ffffff; padding: 12px; border-radius: 6px; border: 1px solid #e9ecef; margin-left: 20px; }
        .level-3 > summary { background: #f8f9fa; padding: 10px; border-radius: 4px; border: 1px solid #f1f3f4; margin-left: 40px; }
        .resource-info { display: flex; justify-content: between; align-items: center; }
        .resource-details { flex: 1; }
        .resource-name { font-weight: 600; color: #333; }
        .resource-type { font-size: 0.9em; color: #666; margin-top: 4px; }
        .cost-info { text-align: right; }
        .cost-final { font-weight: 600; color: #28a745; font-size: 1.1em; }
        .resource-content { margin-top: 10px; }
        .item-info { display: flex; justify-content: between; align-items: center; padding: 8px 12px; background: #f8f9fa; border-radius: 4px; margin: 5px 0; margin-left: 60px; }
        .item-details { flex: 1; }
        .item-name { font-weight: 500; color: #333; }
        .item-description { font-size: 0.85em; color: #666; margin-top: 2px; }
        .item-cost { text-align: right; font-weight: 600; color: #28a745; }
    </style>
</head>
<body>
    <div class="container my-5">
        <div class="text-center mb-5 border-bottom pb-4">
            <h1 class="text-primary mb-3">
                <i class="fas fa-sitemap me-3"></i>${reportTitle}
            </h1>
            ${companyName ? `<h2 class="text-secondary fw-light">${companyName}</h2>` : ''}
            <h3 class="text-dark">${customerName}</h3>
            <p class="text-muted">Generated on ${currentDate}</p>
        </div>

        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h4 class="text-primary">${totalRecords}</h4>
                        <small class="text-muted">Total Billing Records</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h4 class="text-info">${resourceCount}</h4>
                        <small class="text-muted">${selectedBillingType === 'payg' ? 'Resource Groups' : 'Products'}</small>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card text-center">
                    <div class="card-body">
                        <h4 class="text-success">${selectedCurrencySymbol}${totalCost.toFixed(2)}</h4>
                        <small class="text-muted">Total Cost</small>
                    </div>
                </div>
            </div>
        </div>

        <h3 class="mb-3">
            <i class="fas fa-sitemap me-2"></i>Hierarchical Resource Breakdown
        </h3>
        <p class="text-muted mb-4">Native HTML collapsible interface - click to expand/collapse resource dependencies</p>

        <div class="resource-hierarchy">
            ${generateCustomerTreeHTML(customerHierarchy)}
        </div>

        <div class="mt-5 pt-4 border-top text-center text-muted">
            <p class="mb-1">Report generated by Azure Billing Report Generator</p>
            <p class="mb-1">Currency: ${selectedCurrencySymbol === '£' ? 'GBP (£)' : selectedCurrencySymbol}</p>
            <p class="mb-0">Professional Azure billing analysis and reporting</p>
        </div>
    </div>
</body>
</html>`;
        }

        function showSuccess(message) {
            const successAlert = document.getElementById('successAlert');
            if (successAlert) {
                successAlert.querySelector('.alert-message').textContent = message;
                successAlert.classList.remove('hidden');
                successAlert.classList.add('fade-in');

                // Auto-hide after 5 seconds
                setTimeout(() => {
                    successAlert.style.display = 'none';
                }, 5000);
            } else {
                // Create success alert if it doesn't exist
                const alertHtml = `
                    <div id="successAlert" class="alert alert-success alert-dismissible fade-in" role="alert">
                        <i class="fas fa-check-circle me-2"></i>
                        <span class="alert-message">${message}</span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                document.querySelector('.container').insertAdjacentHTML('afterbegin', alertHtml);

                // Auto-hide after 5 seconds
                setTimeout(() => {
                    const alert = document.getElementById('successAlert');
                    if (alert) alert.style.display = 'none';
                }, 5000);
            }
        }
    </script>

    <!-- Individual Customer Reports Section -->
    <div class="card hidden mt-4" id="individualReportsSection">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-users me-2"></i>Individual Customer Reports</h5>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="closeIndividualReports()">
                <i class="fas fa-times me-2"></i>Close
            </button>
        </div>
        <div class="card-body">
            <div id="individualReportsContent">
                <!-- Individual reports content will be populated here -->
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-5 py-4 bg-light border-top">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <p class="mb-0 text-muted small">
                        <i class="fas fa-code me-1"></i>
                        Made by <strong>Rodrigo Quintian</strong> •
                        Licensed under <a href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank"
                            class="text-decoration-none">Apache 2.0</a>
                    </p>
                </div>
                <div class="col-md-4 text-md-end">
                    <a href="https://github.com/cafasdon/azurebillreport" target="_blank"
                        class="btn btn-outline-secondary btn-sm">
                        <i class="fab fa-github me-1"></i>View on GitHub
                    </a>
                </div>
            </div>
        </div>
    </footer>
</body>

</html>