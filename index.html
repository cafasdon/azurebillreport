<!DOCTYPE html>
<!--
Azure Billing Report Generator
Made by Rodrigo Quintian
Licensed under Apache 2.0 License
GitHub: https://github.com/cafasdon/azurebillreport
-->
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure Billing Report Generator</title>

    <!-- External Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        /* Enhanced top bar gradient */
        .bg-gradient-primary {
            background: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%) !important;
        }

        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .step {
            display: flex;
            align-items: center;
            margin: 0 1rem;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            background: #f8f9fa;
            color: #6c757d;
        }

        .step.active {
            background: #007bff;
            color: white;
        }

        .step.completed {
            background: #28a745;
            color: white;
        }

        .upload-zone {
            border: 2px dashed #007bff;
            border-radius: 10px;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-zone:hover {
            background: #f8f9fa;
            border-color: #0056b3;
        }

        .upload-zone.dragover {
            background: #e3f2fd;
            border-color: #1976d2;
        }

        /* Removed currency selection styles - now using fixed GBP currency */

        .progress {
            height: 8px;
        }

        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: 1px solid rgba(0, 0, 0, 0.125);
        }

        /* Native HTML Details/Summary Styling */
        .resource-hierarchy {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        details {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            background: #f8f9fa;
        }

        details[open] {
            background: #e3f2fd;
            border-color: #007bff;
        }

        summary {
            padding: 0.75rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            transition: all 0.3s;
        }

        summary:hover {
            background: rgba(0, 123, 255, 0.1);
        }

        .resource-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .resource-details {
            flex-grow: 1;
        }

        .resource-name {
            font-weight: 600;
            color: #333;
        }

        .resource-type {
            font-size: 0.85em;
            color: #666;
            margin-top: 0.25rem;
        }

        .cost-info {
            text-align: right;
            min-width: 150px;
            margin-left: 1rem;
        }

        .cost-original {
            font-size: 0.85em;
            color: #666;
        }

        .cost-final {
            font-weight: 600;
            color: #28a745;
            font-size: 1.1em;
        }

        .cost-markup {
            font-size: 0.8em;
            color: #dc3545;
        }

        .resource-content {
            padding: 0 1rem 1rem 1rem;
            border-top: 1px solid #dee2e6;
            background: white;
        }

        .meter-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 0.5rem;
            margin-bottom: 0.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .meter-details {
            flex-grow: 1;
        }

        .meter-name {
            font-weight: 500;
            color: #495057;
        }

        .meter-info {
            font-size: 0.8em;
            color: #6c757d;
        }

        .summary-stats {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .level-1 {
            margin-left: 0;
        }

        .level-2 {
            margin-left: 1rem;
        }

        .level-3 {
            margin-left: 2rem;
        }

        .level-4 {
            margin-left: 3rem;
        }

        /* Removed billing type selection styles - now using automatic detection */

        /* License Panel Styles */
        .license-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .license-panel.licensed {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .license-input-group {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .license-input {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 5px;
            font-family: monospace;
        }

        .license-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            transition: background 0.3s;
        }

        .license-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .license-btn.primary {
            background: #007bff;
        }

        .license-btn.primary:hover {
            background: #0056b3;
        }

        .license-status {
            margin-top: 1rem;
            padding: 0.5rem;
            border-radius: 5px;
            display: none;
        }

        .license-status.error {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid rgba(220, 53, 69, 0.5);
            display: block;
        }

        .license-status.success {
            background: rgba(40, 167, 69, 0.2);
            border: 1px solid rgba(40, 167, 69, 0.5);
            display: block;
        }

        .demo-watermark {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 8rem;
            color: rgba(255, 0, 0, 0.05);
            font-weight: bold;
            pointer-events: none;
            z-index: 1000;
            user-select: none;
        }

        .license-badge {
            background: #28a745;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            margin-left: 1rem;
        }

        .buy-license-btn {
            background: #ffc107;
            color: #212529;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            text-decoration: none;
            display: inline-block;
            margin-left: 0.5rem;
            transition: background 0.3s;
        }

        .buy-license-btn:hover {
            background: #e0a800;
            color: #212529;
            text-decoration: none;
        }
    </style>

    <script>
        // Feature flags for demo vs licensed mode
        window.FEATURE_FLAGS = {
            isLicensed: false,
            brandingEnabled: false,
            limits: { maxRows: 25000 }   // demo limit
        };

        // License management system
        const LicenseManager = {
            async checkLicense() {
                const savedKey = localStorage.getItem('abr_license_key');
                if (!savedKey) return false;

                // Check sessionStorage cache first (5 minutes)
                const cacheKey = `license_cache_${savedKey}`;
                const cached = sessionStorage.getItem(cacheKey);
                if (cached) {
                    const cacheData = JSON.parse(cached);
                    const cacheAge = Date.now() - cacheData.timestamp;
                    if (cacheAge < 5 * 60 * 1000) { // 5 minutes
                        console.log('Using cached license validation');
                        this.applyLicense(cacheData.result);
                        return true;
                    }
                }

                return await this.validateKey(savedKey);
            },

            async validateKey(licenseKey) {
                try {
                    this.showStatus('Validating license...', 'info');

                    const response = await fetch('/api/check', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ license_key: licenseKey })
                    });

                    const result = await response.json();

                    if (result.ok) {
                        // Cache the result
                        const cacheKey = `license_cache_${licenseKey}`;
                        sessionStorage.setItem(cacheKey, JSON.stringify({
                            result: result,
                            timestamp: Date.now()
                        }));

                        this.applyLicense(result);
                        localStorage.setItem('abr_license_key', licenseKey);
                        this.showStatus('License activated successfully!', 'success');
                        return true;
                    } else {
                        this.showStatus(this.getErrorMessage(result.reason), 'error');
                        return false;
                    }
                } catch (error) {
                    console.warn('License validation failed:', error);
                    this.showStatus('Network error - running in demo mode', 'error');
                    return false;
                }
            },

            applyLicense(result) {
                window.FEATURE_FLAGS.isLicensed = true;
                window.FEATURE_FLAGS.brandingEnabled = true;
                window.FEATURE_FLAGS.limits.maxRows = Infinity;

                // Apply branding if provided
                if (result.branding) {
                    this.applyBranding(result.branding);
                }

                // Update UI
                this.updateLicensePanel(result);
                this.removeDemoWatermark();
            },

            applyBranding(branding) {
                if (branding.companyName) {
                    document.title = `${branding.companyName} - Azure Billing Report Generator`;
                    const headerTitle = document.querySelector('h1');
                    if (headerTitle) {
                        headerTitle.innerHTML = `<i class="fas fa-chart-line me-3"></i>${branding.companyName} - Azure Billing Report Generator`;
                    }
                }

                if (branding.themeColor) {
                    document.documentElement.style.setProperty('--bs-primary', branding.themeColor);
                }

                if (branding.logoDataUrl) {
                    const logo = document.createElement('img');
                    logo.src = branding.logoDataUrl;
                    logo.style.height = '40px';
                    logo.style.marginRight = '1rem';
                    const headerTitle = document.querySelector('h1');
                    if (headerTitle) {
                        headerTitle.insertBefore(logo, headerTitle.firstChild);
                    }
                }
            },

            updateLicensePanel(result) {
                const panel = document.getElementById('licensePanel');
                const input = document.getElementById('licenseKeyInput');
                const activateBtn = document.getElementById('activateBtn');

                if (panel && result) {
                    panel.classList.add('licensed');
                    panel.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1"><i class="fas fa-check-circle me-2"></i>Licensed Version</h5>
                                <small>Licensed to: ${result.branding?.companyName || 'Licensed Customer'}</small>
                                ${result.license?.expiresAt ? `<br><small>Expires: ${new Date(result.license.expiresAt).toLocaleDateString()}</small>` : ''}
                            </div>
                            <span class="license-badge">
                                <i class="fas fa-certificate me-1"></i>Active
                            </span>
                        </div>
                    `;
                }
            },

            showStatus(message, type) {
                const status = document.getElementById('licenseStatus');
                if (status) {
                    status.textContent = message;
                    status.className = `license-status ${type}`;
                }
            },

            getErrorMessage(reason) {
                const messages = {
                    'missing_key': 'Please enter a license key',
                    'invalid_or_mismatch': 'Invalid license key',
                    'api_error': 'License validation service unavailable',
                    'server_error': 'Server error occurred',
                    'server_config_error': 'Service configuration error'
                };
                return messages[reason] || 'License validation failed';
            },

            removeDemoWatermark() {
                const watermark = document.getElementById('demoWatermark');
                if (watermark) watermark.remove();
            }
        };

        // License activation function
        async function activateLicense() {
            const input = document.getElementById('licenseKeyInput');
            const key = input.value.trim();

            if (!key) {
                LicenseManager.showStatus('Please enter a license key', 'error');
                return;
            }

            const isValid = await LicenseManager.validateKey(key);
            if (isValid) {
                input.value = '';
            }
        }

        // About dialog function
        function showAboutDialog() {
            const version = "2.0 (Firebase)";
            const license = window.FEATURE_FLAGS.isLicensed ? 'Licensed' : 'Demo Mode';
            alert(`Azure Billing Report Generator
Version: ${version}
License: ${license}
Made by Rodrigo Quintian`);
        }
    </script>
</head>

<body>
    <!-- Demo Watermark -->
    <div id="demoWatermark" class="demo-watermark">DEMO</div>

    <!-- Login Wall - Covers entire application until user is authenticated -->
    <div id="loginWall" class="position-fixed w-100 h-100"
        style="top: 0; left: 0; background: rgba(0,0,0,0.95); z-index: 9999; display: flex; align-items: center; justify-content: center;">
        <div class="card shadow-lg" style="max-width: 500px; width: 90%;">
            <div class="card-header bg-primary text-white text-center">
                <h4 class="mb-0"><i class="fas fa-sitemap me-2"></i>Azure Billing Report Generator</h4>
                <p class="mb-0 mt-2">Professional Azure billing analysis and reporting</p>
            </div>
            <div class="card-body p-4">
                <div class="text-center mb-4">
                    <h5 class="text-primary">Sign In Required</h5>
                    <p class="text-muted">Please sign in to access the Azure Billing Report Generator. Registration is
                        required to use all features.</p>
                </div>

                <div class="d-grid gap-3">
                    <button type="button" class="btn btn-primary btn-lg" onclick="signInWithGoogle()">
                        <i class="fab fa-google me-2"></i>Continue with Google
                    </button>

                    <div class="text-center">
                        <small class="text-muted">or</small>
                    </div>

                    <div class="row g-2">
                        <div class="col">
                            <input type="email" id="loginWallEmail" class="form-control" placeholder="Email address"
                                required>
                        </div>
                    </div>
                    <div class="row g-2">
                        <div class="col">
                            <input type="password" id="loginWallPassword" class="form-control" placeholder="Password"
                                required>
                        </div>
                    </div>

                    <div class="row g-2">
                        <div class="col">
                            <button type="button" class="btn btn-success w-100" onclick="signInWithEmailFromWall()">
                                <i class="fas fa-sign-in-alt me-2"></i>Sign In
                            </button>
                        </div>
                        <div class="col">
                            <button type="button" class="btn btn-outline-primary w-100"
                                onclick="createAccountFromWall()">
                                <i class="fas fa-user-plus me-2"></i>Create Account
                            </button>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-4">
                    <small class="text-muted">
                        <i class="fas fa-shield-alt me-1"></i>
                        Your data is secure and never shared with third parties
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- White Label Customization Modal (Enterprise Plan Only) -->
    <div class="modal fade" id="whiteLabelModal" tabindex="-1" aria-labelledby="whiteLabelModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="whiteLabelModalLabel">
                        <i class="fas fa-palette me-2"></i>White Label Customization
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-crown me-2"></i>
                        <strong>Enterprise Exclusive Feature:</strong> Customize the application with your own branding
                        and colors.
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-image me-2"></i>Logo & Branding</h6>
                            <div class="mb-3">
                                <label for="customLogo" class="form-label">Company Logo</label>
                                <input type="file" class="form-control" id="customLogo" accept="image/*">
                                <small class="text-muted">Recommended: 200x50px, PNG/JPG format</small>
                            </div>

                            <div class="mb-3">
                                <label for="companyName" class="form-label">Company Name</label>
                                <input type="text" class="form-control" id="companyName"
                                    placeholder="Your Company Name">
                            </div>

                            <div class="mb-3">
                                <label for="applicationTitle" class="form-label">Application Title</label>
                                <input type="text" class="form-control" id="applicationTitle"
                                    placeholder="Custom Application Title">
                            </div>
                        </div>

                        <div class="col-md-6">
                            <h6><i class="fas fa-palette me-2"></i>Color Scheme</h6>
                            <div class="mb-3">
                                <label for="primaryColor" class="form-label">Primary Color</label>
                                <input type="color" class="form-control form-control-color" id="primaryColor"
                                    value="#0d6efd">
                            </div>

                            <div class="mb-3">
                                <label for="secondaryColor" class="form-label">Secondary Color</label>
                                <input type="color" class="form-control form-control-color" id="secondaryColor"
                                    value="#6c757d">
                            </div>

                            <div class="mb-3">
                                <label for="accentColor" class="form-label">Accent Color</label>
                                <input type="color" class="form-control form-control-color" id="accentColor"
                                    value="#ffc107">
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="darkMode">
                                    <label class="form-check-label" for="darkMode">
                                        Enable Dark Mode
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <div class="row">
                        <div class="col-12">
                            <h6><i class="fas fa-cog me-2"></i>Advanced Options</h6>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="hideFooter">
                                    <label class="form-check-label" for="hideFooter">
                                        Hide "Made by" footer
                                    </label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="customFavicon">
                                    <label class="form-check-label" for="customFavicon">
                                        Use custom favicon
                                    </label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="customCSS" class="form-label">Custom CSS</label>
                                <textarea class="form-control" id="customCSS" rows="4"
                                    placeholder="/* Add your custom CSS here */"></textarea>
                                <small class="text-muted">Advanced users only. Custom CSS will be applied to the
                                    application.</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveWhiteLabelSettings()">
                        <i class="fas fa-save me-1"></i>Save Changes
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="previewWhiteLabel()">
                        <i class="fas fa-eye me-1"></i>Preview
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Verification Wall - Blocks access until email is verified -->
    <div id="emailVerificationWall" class="position-fixed w-100 h-100"
        style="top: 0; left: 0; background: rgba(0,0,0,0.95); z-index: 9999; display: none; align-items: center; justify-content: center;">
        <div class="card shadow-lg" style="max-width: 600px; width: 90%;">
            <div class="card-header bg-warning text-dark text-center">
                <h4 class="mb-0"><i class="fas fa-envelope-open-text me-2"></i>Email Verification Required</h4>
                <p class="mb-0 mt-2">Please verify your email address to continue</p>
            </div>
            <div class="card-body p-4">
                <div class="text-center mb-4">
                    <div class="mb-3">
                        <i class="fas fa-envelope-open-text text-warning" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="text-warning">Verification Email Sent</h5>
                    <p class="text-muted">We've sent a verification email to:</p>
                    <p class="fw-bold" id="verificationEmailAddress">your-email@example.com</p>
                    <p class="text-muted">Please check your inbox and click the verification link to activate your
                        account.</p>
                </div>

                <div class="d-grid gap-3">
                    <button type="button" class="btn btn-warning btn-lg" onclick="checkEmailVerificationStatus()">
                        <i class="fas fa-sync-alt me-2"></i>I've Verified My Email
                    </button>

                    <div class="text-center">
                        <small class="text-muted">Didn't receive the email?</small>
                    </div>

                    <button type="button" class="btn btn-outline-warning" onclick="resendVerificationEmailFromWall()">
                        <i class="fas fa-paper-plane me-2"></i>Resend Verification Email
                    </button>

                    <div class="text-center">
                        <button type="button" class="btn btn-link text-muted" onclick="signOutFromVerificationWall()">
                            <i class="fas fa-sign-out-alt me-1"></i>Sign Out
                        </button>
                    </div>
                </div>

                <div class="text-center mt-4">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Check your spam folder if you don't see the email
                    </small>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4" id="mainApplication" style="display: none;">
        <!-- License Panel -->
        <div id="licensePanel" class="license-panel">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h5 class="mb-1"><i class="fas fa-key me-2"></i>License Activation</h5>
                    <small>Enter your license key to unlock unlimited features</small>
                </div>
                <div class="d-flex align-items-center">
                    <button type="button" class="btn btn-sm btn-outline-light me-2" onclick="showAboutDialog()">
                        <i class="fas fa-info-circle me-1"></i>About
                    </button>
                    <button type="button" class="buy-license-btn" onclick="showPricingModal()">
                        <i class="fas fa-shopping-cart me-1"></i>Buy License
                    </button>
                </div>
            </div>
            <div class="license-input-group">
                <input type="text" id="licenseKeyInput" class="license-input" placeholder="XXXX-XXXX-XXXX-XXXX"
                    maxlength="19">
                <button type="button" id="activateBtn" class="license-btn primary" onclick="activateLicense()">
                    <i class="fas fa-check me-1"></i>Activate
                </button>
            </div>
            <div id="licenseStatus" class="license-status"></div>
        </div>

        <!-- Clean Top Navigation Bar -->
        <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom mb-4">
            <div class="container-fluid">
                <!-- App Title/Logo -->
                <a class="navbar-brand fw-bold text-primary" href="#">
                    <i class="fas fa-chart-line me-2"></i>Azure Billing Generator
                </a>

                <!-- Profile Dropdown (Right Side) -->
                <div id="profileDropdown" class="dropdown">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </nav>

        <!-- Header with Navigation -->
        <div class="text-center mb-4">
            <h1><i class="fas fa-sitemap me-2"></i>Azure Billing Report Generator</h1>
            <p class="lead mb-0">Native HTML hierarchical view with proper resource grouping</p>
        </div>

        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step active" id="step1">
                <i class="fas fa-upload me-2"></i>1. Upload File
            </div>
            <div class="step" id="step2">
                <i class="fas fa-cog me-2"></i>2. Configure
            </div>
            <div class="step" id="step3">
                <i class="fas fa-eye me-2"></i>3. Preview
            </div>
            <div class="step" id="step4">
                <i class="fas fa-magic me-2"></i>4. Generate
            </div>
        </div>

        <!-- Step 1: Upload -->
        <div class="card" id="uploadSection">
            <div class="card-header">
                <h5><i class="fas fa-upload me-2"></i>Step 1: Upload Azure Billing File</h5>
            </div>
            <div class="card-body">
                <!-- Automatic Billing Type Detection (no manual selection needed) -->

                <div class="upload-zone" id="uploadZone">
                    <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-primary"></i>
                    <h4>Drop your billing file here</h4>
                    <p>or click to browse for files</p>
                    <p class="text-muted">Supported formats: .xls, .xlsx, .csv</p>
                </div>
                <input type="file" id="fileInput" accept=".xls,.xlsx,.csv" class="hidden">

                <div class="alert alert-info mt-3" id="sampleDataInfo">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="mb-1"><i class="fas fa-info-circle me-2"></i>Need help with file structure?</h6>
                            <p class="mb-0 small">Download our sample files to see the expected Azure billing data
                                formats. The system will automatically detect your billing type. Supports Excel (.xlsx,
                                .xls) and CSV (.csv) files.</p>
                        </div>
                        <div class="btn-group">
                            <a href="./example/AzureBilling_Sample_Structure.xlsx"
                                download="AzureBilling_Sample_Structure.xlsx" class="btn btn-primary btn-sm">
                                <i class="fas fa-download me-2"></i>Pay-as-you-go Sample
                            </a>
                            <a href="./example/RI_Sample_MockData.xlsx" download="RI_Sample_MockData.xlsx"
                                class="btn btn-primary btn-sm">
                                <i class="fas fa-download me-2"></i>Reserved Instances Sample
                            </a>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">
                            <strong>Pay-as-you-go:</strong> VM with dependencies, resource groups, parent-child
                            relationships ‚Ä¢
                            <strong>Reserved Instances:</strong> Customer subscriptions, reserved capacity billing,
                            product SKUs
                        </small>
                    </div>
                </div>

                <div id="uploadProgress" class="mt-3 hidden">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
                    </div>
                </div>

                <div id="fileInfo" class="mt-3 hidden">
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>File uploaded successfully!</strong>
                        <div id="fileDetails"></div>
                    </div>
                    <div class="text-end">
                        <button type="button" class="btn btn-primary" onclick="proceedToConfig()">
                            <i class="fas fa-arrow-right me-2"></i>Configure Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Configure -->
        <div class="card hidden" id="configSection">
            <div class="card-header">
                <h5><i class="fas fa-cog me-2"></i>Step 2: Configure Report Settings</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-6">
                        <h6><i class="fas fa-money-bill-wave me-2"></i>Currency</h6>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            All billing reports use <strong>GBP (¬£)</strong> as the standard currency.
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <h6><i class="fas fa-percentage me-2"></i>Markup Configuration</h6>
                        <div class="mb-3">
                            <label for="globalMarkup" class="form-label">Global Markup Percentage</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="globalMarkup" value="0" min="0" max="1000"
                                    step="0.1">
                                <span class="input-group-text">%</span>
                            </div>
                            <div class="form-text">Apply this markup to all costs (e.g., 20% for sales margin)</div>
                        </div>

                        <div class="mb-3">
                            <label for="companyName" class="form-label">Company Name (Optional)</label>
                            <input type="text" class="form-control" id="companyName" placeholder="Your Company Name">
                        </div>

                        <div class="mb-3">
                            <label for="reportTitle" class="form-label">Report Title</label>
                            <input type="text" class="form-control" id="reportTitle" value="Azure Billing Report">
                        </div>
                    </div>
                </div>

                <div class="text-end mt-4">
                    <button type="button" class="btn btn-outline-secondary me-2" onclick="backToUpload()">
                        <i class="fas fa-arrow-left me-2"></i>Back to Upload
                    </button>
                    <button type="button" class="btn btn-primary" onclick="proceedToPreview()">
                        <i class="fas fa-arrow-right me-2"></i>Preview Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 3: Preview -->
        <div class="card hidden" id="previewSection">
            <div class="card-header">
                <h5><i class="fas fa-eye me-2"></i>Step 3: Hierarchical Data Preview</h5>
            </div>
            <div class="card-body">
                <div id="previewContent">
                    <!-- Preview content will be populated here -->
                </div>

                <div class="text-end mt-4">
                    <button type="button" class="btn btn-outline-secondary me-2" onclick="backToConfig()">
                        <i class="fas fa-arrow-left me-2"></i>Back to Configuration
                    </button>
                    <button type="button" class="btn btn-primary" onclick="generateReport()">
                        <i class="fas fa-magic me-2"></i>Generate Report
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 4: Generate -->
        <div class="card hidden" id="generateSection">
            <div class="card-header">
                <h5><i class="fas fa-magic me-2"></i>Step 4: Generate Report</h5>
            </div>
            <div class="card-body">
                <div id="generateContent">
                    <!-- Generate content will be populated here -->
                </div>
            </div>
        </div>

        <!-- Report Preview Section -->
        <div class="card hidden mt-4" id="reportPreviewSection">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Hierarchical Report Preview</h5>
                <div>
                    <button type="button" class="btn btn-success btn-sm me-2" onclick="exportReport()">
                        <i class="fas fa-download me-2"></i>Export HTML
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="closeReportPreview()">
                        <i class="fas fa-times me-2"></i>Close Preview
                    </button>
                </div>
            </div>
            <div class="card-body p-3">
                <div id="reportContent" style="max-height: 600px; overflow-y: auto;">
                    <!-- Generated report will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables - simple and clean
        let uploadedData = null;
        let processedData = null;
        let hierarchicalData = null;
        let currentStep = 1;
        let globalMarkupPercent = 0;
        // Fixed currency - always use GBP for all billing reports
        let selectedCurrency = 'GBP';
        let selectedCurrencySymbol = '¬£';
        let companyName = '';
        let reportTitle = 'Azure Billing Report';
        let selectedBillingType = 'payg'; // 'payg' or 'ri'

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function () {
            console.log('üöÄ Initializing Azure Billing Report Generator (Firebase)');

            // Check for existing license
            const isLicensed = await LicenseManager.checkLicense();

            if (!isLicensed) {
                console.log('‚è≥ Running in demo mode - limited to 25,000 rows');
            } else {
                console.log('‚úÖ Licensed version activated');
            }

            setupEventListeners();
        });

        // Add user info to header
        function addUserInfoToHeader() {
            let user = null;
            let license = null;

            // Get user and license from integrated manager or fallback to individual systems
            if (window.USER_LICENSE_MANAGER && USER_LICENSE_MANAGER.isAuthenticated) {
                user = USER_LICENSE_MANAGER.getCurrentUser();
                license = USER_LICENSE_MANAGER.getCurrentLicense();
            } else if (window.AUTH_SYSTEM && AUTH_SYSTEM.isUserAuthenticated()) {
                user = AUTH_SYSTEM.getCurrentUser();
            }

            if (!user) return;

            const headerTitle = document.querySelector('h1');

            if (headerTitle && user && !document.querySelector('.user-dropdown')) {
                // Add user dropdown to header
                const userDropdown = document.createElement('div');
                userDropdown.className = 'dropdown d-inline-block ms-3 user-dropdown';

                // Build license info
                const licenseInfo = license ? `
                    <li><span class="dropdown-item-text text-success small">
                        <i class="fas fa-certificate me-1"></i>Licensed to: ${license.licensee}
                    </span></li>
                    <li><hr class="dropdown-divider"></li>
                ` : '';

                userDropdown.innerHTML = `
                    <button class="btn btn-outline-primary dropdown-toggle btn-sm" type="button" data-bs-toggle="dropdown">
                        ${user.picture ? `<img src="${user.picture}" class="rounded-circle me-2" width="24" height="24">` : '<i class="fas fa-user me-2"></i>'}
                        ${user.name || user.email}
                        ${license ? '<i class="fas fa-certificate text-success ms-1" title="Licensed"></i>' : ''}
                    </button>
                    <ul class="dropdown-menu">
                        <li><h6 class="dropdown-header">${user.name}</h6></li>
                        <li><span class="dropdown-item-text text-muted small">${user.email}</span></li>
                        ${licenseInfo}
                        <li><a class="dropdown-item" href="#" onclick="${window.USER_LICENSE_MANAGER ? 'USER_LICENSE_MANAGER.signOut()' : 'AUTH_SYSTEM.signOut()'}">
                            <i class="fas fa-sign-out-alt me-2"></i>Sign Out
                        </a></li>
                    </ul>
                `;

                headerTitle.appendChild(userDropdown);

                // Initialize dropdown if Bootstrap is available
                if (window.bootstrap && bootstrap.Dropdown) {
                    new bootstrap.Dropdown(userDropdown.querySelector('.dropdown-toggle'));
                }
            }
        }

        function setupEventListeners() {
            // Removed billing type selection events - now using automatic detection

            // File upload events
            document.getElementById('uploadZone').addEventListener('click', function () {
                document.getElementById('fileInput').click();
            });

            document.getElementById('fileInput').addEventListener('change', handleFileSelect);

            // Drag and drop events
            const uploadZone = document.getElementById('uploadZone');
            uploadZone.addEventListener('dragover', function (e) {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', function (e) {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
            });

            uploadZone.addEventListener('drop', function (e) {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });

            // Markup input
            document.getElementById('globalMarkup').addEventListener('input', function () {
                globalMarkupPercent = parseFloat(this.value) || 0;
            });

            // Company info
            document.getElementById('companyName').addEventListener('input', function () {
                companyName = this.value;
            });

            document.getElementById('reportTitle').addEventListener('input', function () {
                reportTitle = this.value || 'Azure Billing Report';
            });
        }

        // Removed handleBillingTypeChange function - now using automatic detection

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            // Validate file type
            const validTypes = [
                'application/vnd.ms-excel',
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                'text/csv',
                'application/csv'
            ];

            if (!validTypes.includes(file.type) && !file.name.match(/\.(xls|xlsx|csv)$/i)) {
                showError('Please select a valid billing file (.xls, .xlsx, or .csv)');
                return;
            }

            // Show progress
            document.getElementById('uploadProgress').classList.remove('hidden');
            document.querySelector('.progress-bar').style.width = '20%';

            // Determine file type and read accordingly
            const fileExtension = file.name.split('.').pop().toLowerCase();

            if (fileExtension === 'csv') {
                // Handle CSV files
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        document.querySelector('.progress-bar').style.width = '60%';

                        // Parse CSV file
                        const csvText = e.target.result;

                        // Auto-detect delimiter (comma or semicolon)
                        const firstLine = csvText.split('\n')[0];
                        const delimiter = firstLine.includes(';') ? ';' : ',';

                        const parseResult = Papa.parse(csvText, {
                            header: true,
                            delimiter: delimiter,
                            skipEmptyLines: true,
                            transformHeader: function (header) {
                                return header.trim(); // Remove any whitespace from headers
                            }
                        });

                        if (parseResult.errors.length > 0) {
                            console.warn('CSV parsing warnings:', parseResult.errors);
                        }

                        const jsonData = parseResult.data;
                        document.querySelector('.progress-bar').style.width = '100%';

                        // Process the data
                        processUploadedData(jsonData, file);

                    } catch (error) {
                        console.error('Error processing CSV file:', error);
                        showError('Error processing CSV file. Please ensure it\'s a valid CSV file with billing data.');
                        document.getElementById('uploadProgress').classList.add('hidden');
                    }
                };
                reader.readAsText(file);

            } else {
                // Handle Excel files (.xls, .xlsx)
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        document.querySelector('.progress-bar').style.width = '60%';

                        // Parse Excel file
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });

                        // Get first sheet
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];

                        // Convert to JSON with options to handle missing headers
                        const rawData = XLSX.utils.sheet_to_json(worksheet, {
                            header: 1,  // Use first row as headers
                            defval: '',  // Default value for empty cells
                            blankrows: false  // Skip blank rows
                        });

                        let jsonData;

                        // Convert array format to object format manually to ensure all columns are preserved
                        if (rawData.length > 0) {
                            const headers = rawData[0];
                            const rows = rawData.slice(1);

                            jsonData = rows.map(row => {
                                const obj = {};
                                headers.forEach((header, index) => {
                                    // Handle empty or undefined headers
                                    const cleanHeader = header && header.toString().trim() ? header.toString().trim() : `Column_${index}`;
                                    obj[cleanHeader] = row[index] || '';
                                });
                                return obj;
                            });
                        } else {
                            jsonData = rawData;
                        }

                        document.querySelector('.progress-bar').style.width = '100%';

                        // Process the data
                        processUploadedData(jsonData, file);

                    } catch (error) {
                        console.error('Error processing Excel file:', error);
                        showError('Error processing Excel file. Please ensure it\'s a valid Excel file with billing data.');
                        document.getElementById('uploadProgress').classList.add('hidden');
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        }

        // Enhanced document detection system with filename analysis and multi-customer support
        function analyzeFilename(filename) {
            if (!filename) return { type: null, confidence: 0 };

            const normalizedName = filename.toLowerCase();

            // High confidence filename patterns
            if (normalizedName.includes('azureservicesbillingreport')) {
                return { type: 'ri', confidence: 0.9, source: 'filename_pattern' };
            }
            if (normalizedName.includes('azureusagesummary')) {
                return { type: 'payg', confidence: 0.9, source: 'filename_pattern' };
            }

            // Medium confidence patterns
            if (normalizedName.includes('billing') && normalizedName.includes('report')) {
                return { type: 'ri', confidence: 0.6, source: 'filename_keywords' };
            }
            if (normalizedName.includes('usage') && normalizedName.includes('summary')) {
                return { type: 'payg', confidence: 0.6, source: 'filename_keywords' };
            }

            return { type: null, confidence: 0 };
        }

        function analyzeColumnStructure(data) {
            if (!data || data.length === 0) return { type: null, confidence: 0 };

            const firstRow = data[0];
            const columns = Object.keys(firstRow);
            const normalizedColumns = columns.map(col => col.trim().toLowerCase());

            // Helper function for flexible column matching
            function hasColumn(targetCol) {
                const normalizedTarget = targetCol.toLowerCase();
                return normalizedColumns.some(col =>
                    col === normalizedTarget ||
                    col.includes(normalizedTarget) ||
                    normalizedTarget.includes(col)
                );
            }

            // PayG strong indicators (resource-level granularity)
            const paygStrongIndicators = ['Resource Group', 'Meter Name', 'Usage Date'];
            const hasStrongPaygIndicators = paygStrongIndicators.every(col => hasColumn(col));

            // PayG supporting columns
            const paygSupportingColumns = ['Total Cost', 'Tags', 'Meter Id', 'Meter Region'];
            const paygSupportingCount = paygSupportingColumns.filter(col => hasColumn(col)).length;

            // RI specific indicators (subscription-level billing)
            const riSpecificColumns = ['Sub Total', 'Billing Period', 'Sku Name', 'Subscription StartDate', 'Subscription EndDate'];
            const riSpecificCount = riSpecificColumns.filter(col => hasColumn(col)).length;

            // RI supporting columns
            const riSupportingColumns = ['Publisher Name', 'Customer TenantId', 'Product Category'];
            const riSupportingCount = riSupportingColumns.filter(col => hasColumn(col)).length;

            // Calculate confidence scores
            let paygConfidence = 0;
            let riConfidence = 0;

            if (hasStrongPaygIndicators) {
                paygConfidence = 0.7 + (paygSupportingCount * 0.1);
            } else if (paygSupportingCount >= 2) {
                paygConfidence = 0.4 + (paygSupportingCount * 0.1);
            }

            if (riSpecificCount >= 2) {
                riConfidence = 0.6 + (riSpecificCount * 0.1) + (riSupportingCount * 0.05);
            } else if (riSpecificCount >= 1) {
                riConfidence = 0.3 + (riSpecificCount * 0.1);
            }

            // Determine type based on confidence
            if (paygConfidence > riConfidence && paygConfidence > 0.5) {
                return { type: 'payg', confidence: Math.min(paygConfidence, 1.0), source: 'column_structure' };
            } else if (riConfidence > paygConfidence && riConfidence > 0.5) {
                return { type: 'ri', confidence: Math.min(riConfidence, 1.0), source: 'column_structure' };
            }

            return { type: null, confidence: 0 };
        }

        function analyzeCustomerStructure(data) {
            if (!data || data.length === 0) return { isMultiCustomer: false, customerCount: 0, customers: [] };

            // Check for customer identification columns
            const customerColumns = ['Customer Name', 'Customer Account Number', 'CustomerId'];
            let customerColumn = null;

            for (const col of customerColumns) {
                if (data[0].hasOwnProperty(col)) {
                    customerColumn = col;
                    break;
                }
            }

            if (!customerColumn) {
                return { isMultiCustomer: false, customerCount: 0, customers: [] };
            }

            // Count unique customers
            const uniqueCustomers = [...new Set(data.map(row => row[customerColumn]).filter(name => name && name.trim()))];

            return {
                // If the file has customer columns, it should be treated as multi-customer structure
                // even if it only contains one customer (for proper hierarchy and individual reports)
                isMultiCustomer: true,
                customerCount: uniqueCustomers.length,
                customers: uniqueCustomers,
                customerColumn: customerColumn
            };
        }

        function detectDocumentType(data, filename) {
            // Phase 1: Filename analysis (highest priority)
            const filenameAnalysis = analyzeFilename(filename);

            // Phase 2: Column structure analysis
            const columnAnalysis = analyzeColumnStructure(data);

            // Phase 3: Customer structure analysis
            const customerAnalysis = analyzeCustomerStructure(data);

            // Combine analyses with weighted confidence
            let finalType = null;
            let finalConfidence = 0;
            let sources = [];

            // Filename has highest weight if confidence is high
            if (filenameAnalysis.confidence >= 0.8) {
                finalType = filenameAnalysis.type;
                finalConfidence = filenameAnalysis.confidence;
                sources.push(filenameAnalysis.source);
            }
            // If filename confidence is medium, combine with column analysis
            else if (filenameAnalysis.confidence >= 0.5 && columnAnalysis.type === filenameAnalysis.type) {
                finalType = filenameAnalysis.type;
                finalConfidence = (filenameAnalysis.confidence * 0.6) + (columnAnalysis.confidence * 0.4);
                sources.push(filenameAnalysis.source, columnAnalysis.source);
            }
            // Use column analysis if filename is not reliable
            else if (columnAnalysis.confidence >= 0.6) {
                finalType = columnAnalysis.type;
                finalConfidence = columnAnalysis.confidence;
                sources.push(columnAnalysis.source);
            }
            // Fallback to any available analysis
            else if (filenameAnalysis.confidence > columnAnalysis.confidence) {
                finalType = filenameAnalysis.type;
                finalConfidence = filenameAnalysis.confidence;
                sources.push(filenameAnalysis.source);
            } else if (columnAnalysis.confidence > 0) {
                finalType = columnAnalysis.type;
                finalConfidence = columnAnalysis.confidence;
                sources.push(columnAnalysis.source);
            }

            return {
                billingType: finalType,
                confidence: finalConfidence,
                sources: sources,
                customerStructure: customerAnalysis,
                filenameAnalysis: filenameAnalysis,
                columnAnalysis: columnAnalysis
            };
        }

        // Legacy function for backward compatibility
        function detectBillingType(data) {
            const result = detectDocumentType(data, null);
            return result.billingType;
        }

        // Enhanced precision functions for currency calculations
        function parseCurrencyValue(value) {
            if (value === null || value === undefined || value === '') {
                return 0;
            }

            // Handle string values that might contain currency symbols or formatting
            if (typeof value === 'string') {
                // Remove currency symbols, commas, and other non-numeric characters except decimal point and minus
                const cleanValue = value.replace(/[^\d.-]/g, '');
                const parsed = parseFloat(cleanValue);
                return isNaN(parsed) ? 0 : parsed;
            }

            // Handle numeric values
            const parsed = parseFloat(value);
            return isNaN(parsed) ? 0 : parsed;
        }

        function calculateMarkup(originalCost, markupPercent) {
            const original = parseCurrencyValue(originalCost);
            const percent = parseCurrencyValue(markupPercent);

            // Use precise calculation to avoid floating-point errors
            const markupAmount = Math.round((original * percent / 100) * 100) / 100;
            return markupAmount;
        }

        function calculateFinalCost(originalCost, markupAmount) {
            const original = parseCurrencyValue(originalCost);
            const markup = parseCurrencyValue(markupAmount);

            // Use precise calculation to avoid floating-point errors
            const finalCost = Math.round((original + markup) * 100) / 100;
            return finalCost;
        }

        function formatCurrency(value, decimals = 2) {
            const numValue = parseCurrencyValue(value);
            return numValue.toFixed(decimals);
        }

        function validateCostData(row, billingType) {
            const costField = billingType === 'payg' ? 'Total Cost' : 'Sub Total';
            const costValue = row[costField];

            if (costValue === null || costValue === undefined || costValue === '') {
                console.warn(`Missing cost data in row:`, row);
                return false;
            }

            const parsed = parseCurrencyValue(costValue);
            if (parsed < 0) {
                console.warn(`Negative cost value detected:`, costValue, 'in row:', row);
            }

            return true;
        }

        function processUploadedData(data, file) {
            uploadedData = data;

            // Validate data structure
            if (!data || data.length === 0) {
                showError('The uploaded file appears to be empty or invalid.');
                return;
            }

            // Check row limit for demo version
            if (!window.FEATURE_FLAGS.isLicensed && data.length > window.FEATURE_FLAGS.limits.maxRows) {
                showError(`This file contains ${data.length.toLocaleString()} rows, but the demo version is limited to ${window.FEATURE_FLAGS.limits.maxRows.toLocaleString()} rows. Please activate a license for unlimited processing.`);
                return;
            }

            // Enhanced document detection with filename analysis
            const detectionResult = detectDocumentType(data, file.name);

            if (detectionResult.billingType && detectionResult.confidence >= 0.5) {
                selectedBillingType = detectionResult.billingType;

                // Store detection metadata for debugging and reporting
                window.documentDetection = detectionResult;

                console.log('Document Detection Results:', {
                    billingType: detectionResult.billingType,
                    confidence: detectionResult.confidence.toFixed(2),
                    sources: detectionResult.sources,
                    customerStructure: detectionResult.customerStructure,
                    filename: file.name
                });

                // Show detection info to user if confidence is low
                if (detectionResult.confidence < 0.8) {
                    console.warn(`Document type detection confidence is ${(detectionResult.confidence * 100).toFixed(1)}%. Please verify the results.`);
                }
            } else {
                let errorMessage = 'Unable to determine billing type. Please ensure your file contains the expected Azure billing structure.';
                if (detectionResult.confidence > 0) {
                    errorMessage += ` Detection confidence was only ${(detectionResult.confidence * 100).toFixed(1)}%.`;
                }
                showError(errorMessage);
                return;
            }

            // Process data based on billing type
            if (selectedBillingType === 'payg') {
                // Fix Usage Date format and calculate costs for Pay-as-you-go data
                uploadedData = uploadedData.map(row => {
                    if (row['Usage Date']) {
                        // Handle Excel date serial numbers and various date formats
                        let usageDate = row['Usage Date'];
                        if (typeof usageDate === 'number') {
                            // Excel date serial number conversion
                            const excelEpoch = new Date(1900, 0, 1);
                            usageDate = new Date(excelEpoch.getTime() + (usageDate - 2) * 24 * 60 * 60 * 1000);
                        }
                        row['Usage Date'] = formatDate(usageDate);
                    }

                    // Store original cost for later calculation
                    row['Original Cost'] = parseFloat(row['Total Cost']) || 0;

                    return row;
                });
            } else {
                // Process Reserved Instances data - normalize date fields and calculate costs
                uploadedData = uploadedData.map(row => {
                    // Normalize billing period and subscription dates
                    if (row['Billing Period']) {
                        row['Billing Period'] = formatDate(row['Billing Period']);
                    }
                    if (row['Subscription StartDate']) {
                        row['Subscription StartDate'] = formatDate(row['Subscription StartDate']);
                    }
                    if (row['Subscription EndDate']) {
                        row['Subscription EndDate'] = formatDate(row['Subscription EndDate']);
                    }

                    // Store original cost for later calculation (RI uses 'Sub Total' instead of 'Total Cost')
                    row['Original Cost'] = parseFloat(row['Sub Total']) || 0;

                    return row;
                });
            }

            // Show file info with auto-detected billing type
            const billingTypeLabel = selectedBillingType === 'payg' ? 'Pay-as-you-go' : 'Reserved Instances';
            document.getElementById('fileDetails').innerHTML = `
                <div class="mt-2">
                    <strong>File:</strong> ${file.name}<br>
                    <strong>Size:</strong> ${(file.size / 1024).toFixed(1)} KB<br>
                    <strong>Records:</strong> ${data.length.toLocaleString()}<br>
                    <strong>Auto-detected Type:</strong> ${billingTypeLabel}<br>
                    <strong>Currency:</strong> ${selectedCurrency} (${selectedCurrencySymbol})
                </div>
            `;

            document.getElementById('fileInfo').classList.remove('hidden');
            document.getElementById('uploadProgress').classList.add('hidden');
        }

        function formatDate(date) {
            if (!date) return 'N/A';
            if (typeof date === 'string') return date;

            try {
                const d = new Date(date);
                if (isNaN(d.getTime())) return 'N/A';
                return d.toISOString().split('T')[0]; // YYYY-MM-DD format
            } catch (e) {
                return 'N/A';
            }
        }

        // Removed autoDetectCurrency function - now using fixed GBP currency

        // Removed selectCurrency function - now using fixed GBP currency

        // Navigation functions
        function proceedToConfig() {
            if (!uploadedData) {
                showError('Please upload a file first.');
                return;
            }
            currentStep = 2;
            updateStepIndicator();
            showSection('configSection');
        }

        function backToUpload() {
            currentStep = 1;
            updateStepIndicator();
            showSection('uploadSection');
        }

        function proceedToPreview() {
            if (!uploadedData) {
                showError('Please upload a file first.');
                return;
            }

            // Process data with markup based on billing type
            processedData = uploadedData.map(row => {
                // Validate cost data first
                if (!validateCostData(row, selectedBillingType)) {
                    console.warn('Invalid cost data in row, using 0:', row);
                }

                // Use the correct cost field based on billing type with enhanced parsing
                let originalCost;
                if (selectedBillingType === 'payg') {
                    originalCost = parseCurrencyValue(row['Total Cost']);
                } else {
                    originalCost = parseCurrencyValue(row['Sub Total']);
                }

                const markupAmount = calculateMarkup(originalCost, globalMarkupPercent);
                const finalCost = calculateFinalCost(originalCost, markupAmount);

                return {
                    ...row,
                    'Original Cost': originalCost,
                    'Markup Amount': markupAmount,
                    'Final Cost': finalCost
                };
            });

            // Create hierarchical structure using proper Azure resource relationships
            hierarchicalData = createHierarchicalStructure(processedData);

            // Generate preview
            generateHierarchicalPreview();

            currentStep = 3;
            updateStepIndicator();
            showSection('previewSection');
        }

        function backToConfig() {
            currentStep = 2;
            updateStepIndicator();
            showSection('configSection');
        }

        function createHierarchicalStructure(data) {
            if (selectedBillingType === 'payg') {
                return createPaygHierarchy(data);
            } else {
                return createRiHierarchy(data);
            }
        }

        function createPaygHierarchy(data) {
            const hierarchy = {};

            // Use customer structure analysis to determine hierarchy
            const customerStructure = window.documentDetection?.customerStructure || analyzeCustomerStructure(data);
            const isMultiCustomer = customerStructure.isMultiCustomer;
            const customerColumn = customerStructure.customerColumn;

            // Multi-customer structure: Customer ‚Üí Resource Group ‚Üí Resource ‚Üí Product/Meter
            // Single-customer structure: Resource Group ‚Üí Resource ‚Üí Product/Meter
            data.forEach(row => {
                const resourceGroup = row['Resource Group'] || 'Unknown Resource Group';
                const resourceName = row['Resource Name'] || 'Unknown Resource';
                const productName = row['Product Name'] || 'Unknown Product';
                const meterName = row['Meter Name'] || 'Unknown Meter';
                const tags = row['Tags'] || '';
                const customerName = isMultiCustomer ? (row[customerColumn] || 'Unknown Customer') : null;

                if (isMultiCustomer) {
                    // Multi-customer hierarchy: Customer ‚Üí Resource Group ‚Üí Resource ‚Üí Product/Meter

                    // Initialize customer level
                    if (!hierarchy[customerName]) {
                        hierarchy[customerName] = {
                            name: customerName,
                            type: 'Customer',
                            resources: {},
                            totalCost: 0,
                            totalOriginalCost: 0,
                            totalMarkupAmount: 0,
                            itemCount: 0
                        };
                    }

                    // Initialize resource group within customer
                    if (!hierarchy[customerName].resources[resourceGroup]) {
                        hierarchy[customerName].resources[resourceGroup] = {
                            name: resourceGroup,
                            type: 'Resource Group',
                            resources: {},
                            totalCost: 0,
                            totalOriginalCost: 0,
                            totalMarkupAmount: 0,
                            itemCount: 0
                        };
                    }
                } else {
                    // Single-customer hierarchy: Resource Group ‚Üí Resource ‚Üí Product/Meter

                    // Initialize resource group
                    if (!hierarchy[resourceGroup]) {
                        hierarchy[resourceGroup] = {
                            name: resourceGroup,
                            type: 'Resource Group',
                            resources: {},
                            totalCost: 0,
                            totalOriginalCost: 0,
                            totalMarkupAmount: 0,
                            itemCount: 0
                        };
                    }
                }

                // Get the appropriate container for resource groups
                const rgContainer = isMultiCustomer ? hierarchy[customerName].resources[resourceGroup] : hierarchy[resourceGroup];

                // Initialize resource within group
                if (!rgContainer.resources[resourceName]) {
                    rgContainer.resources[resourceName] = {
                        name: resourceName,
                        type: getResourceType(productName, meterName),
                        products: {},
                        totalCost: 0,
                        totalOriginalCost: 0,
                        totalMarkupAmount: 0,
                        itemCount: 0,
                        tags: tags,
                        parentResource: extractParentResource(tags)
                    };
                }

                // Initialize product within resource
                const productKey = `${productName}_${meterName}`;
                if (!rgContainer.resources[resourceName].products[productKey]) {
                    rgContainer.resources[resourceName].products[productKey] = {
                        name: productName,
                        meterName: meterName,
                        type: 'Product/Meter',
                        items: [],
                        totalCost: 0,
                        totalOriginalCost: 0,
                        totalMarkupAmount: 0,
                        itemCount: 0
                    };
                }

                // Calculate costs with current markup
                const originalCost = row['Original Cost'];
                const markupAmount = originalCost * (globalMarkupPercent / 100);
                const finalCost = originalCost + markupAmount;

                // Add the individual item
                const product = rgContainer.resources[resourceName].products[productKey];
                product.items.push({
                    usageDate: row['Usage Date'],
                    quantity: row['Quantity'],
                    unitPrice: row['Unit Price'],
                    originalCost: originalCost,
                    markupAmount: markupAmount,
                    finalCost: finalCost,
                    meterRegion: row['Meter Region']
                });

                // Update totals at all levels
                product.totalOriginalCost += originalCost;
                product.totalMarkupAmount += markupAmount;
                product.totalCost += finalCost;
                product.itemCount += 1;

                const resource = rgContainer.resources[resourceName];
                resource.totalOriginalCost += originalCost;
                resource.totalMarkupAmount += markupAmount;
                resource.totalCost += finalCost;
                resource.itemCount += 1;

                rgContainer.totalOriginalCost += originalCost;
                rgContainer.totalMarkupAmount += markupAmount;
                rgContainer.totalCost += finalCost;
                rgContainer.itemCount += 1;

                // If multi-customer, also update customer totals
                if (isMultiCustomer) {
                    hierarchy[customerName].totalOriginalCost += originalCost;
                    hierarchy[customerName].totalMarkupAmount += markupAmount;
                    hierarchy[customerName].totalCost += finalCost;
                    hierarchy[customerName].itemCount += 1;
                }
            });

            return hierarchy;
        }

        function createRiHierarchy(data) {
            const hierarchy = {};

            // Use customer structure analysis to determine hierarchy
            const customerStructure = window.documentDetection?.customerStructure || analyzeCustomerStructure(data);
            const isMultiCustomer = customerStructure.isMultiCustomer;
            const customerColumn = customerStructure.customerColumn;

            // Multi-customer structure: Customer ‚Üí Product ‚Üí SKU
            // Single-customer structure: Product ‚Üí SKU
            data.forEach(row => {
                const customerName = isMultiCustomer ? (row[customerColumn] || 'Unknown Customer') : null;
                const subscriptionId = row['Subscription Id'] || 'Unknown Subscription';
                const productName = row['Product Name'] || 'Unknown Product';
                const skuName = row['Sku Name'] || 'Unknown SKU';
                const billingPeriod = row['Billing Period'] || 'Unknown Period';

                if (isMultiCustomer) {
                    // Multi-customer hierarchy: Customer ‚Üí Product ‚Üí SKU

                    // Initialize customer
                    if (!hierarchy[customerName]) {
                        hierarchy[customerName] = {
                            name: customerName,
                            type: 'Customer',
                            resources: {},
                            totalCost: 0,
                            totalOriginalCost: 0,
                            totalMarkupAmount: 0,
                            itemCount: 0
                        };
                    }
                }
                // For single-customer, products will be at the top level (no customer level)

                // Get the appropriate container for products
                const productContainer = isMultiCustomer ? hierarchy[customerName].resources : hierarchy;

                // Initialize product (group by product name)
                const productKey = productName;
                if (!productContainer[productKey]) {
                    productContainer[productKey] = {
                        name: productName,
                        meterName: skuName,
                        type: isMultiCustomer ? 'Reserved Instance' : 'Product',
                        items: [],
                        totalCost: 0,
                        totalOriginalCost: 0,
                        totalMarkupAmount: 0,
                        itemCount: 0
                    };
                }

                // Calculate costs with current markup
                const originalCost = row['Sub Total'] || row['Original Cost'] || 0;
                const markupAmount = originalCost * (globalMarkupPercent / 100);
                const finalCost = originalCost + markupAmount;

                // Add the individual reservation item with subscription context
                const product = productContainer[productKey];
                product.items.push({
                    usageDate: billingPeriod,
                    quantity: row['Quantity'],
                    unitPrice: row['Unit Price'],
                    originalCost: originalCost,
                    markupAmount: markupAmount,
                    finalCost: finalCost,
                    meterRegion: 'Reserved Instance',
                    subscriptionId: subscriptionId,
                    subscriptionStartDate: row['Subscription StartDate'],
                    subscriptionEndDate: row['Subscription EndDate'],
                    customerId: row['CustomerId'],
                    publisherName: row['Publisher Name'],
                    productCategory: row['Product Category'],
                    skuName: skuName
                });

                // Update totals at product level
                product.totalOriginalCost += originalCost;
                product.totalMarkupAmount += markupAmount;
                product.totalCost += finalCost;
                product.itemCount += 1;

                // If multi-customer, also update customer totals
                if (isMultiCustomer) {
                    hierarchy[customerName].totalOriginalCost += originalCost;
                    hierarchy[customerName].totalMarkupAmount += markupAmount;
                    hierarchy[customerName].totalCost += finalCost;
                    hierarchy[customerName].itemCount += 1;
                }
            });

            return hierarchy;
        }

        function getResourceType(productName, meterName) {
            if (productName.includes('Virtual Machine') || meterName.includes('VM')) return 'Virtual Machine';
            if (productName.includes('Disk') || meterName.includes('Disk')) return 'Storage Disk';
            if (productName.includes('Backup') || meterName.includes('Backup')) return 'Backup Service';
            if (productName.includes('Network') || meterName.includes('Network')) return 'Network Service';
            if (productName.includes('Storage') || meterName.includes('Storage')) return 'Storage Service';
            return 'Azure Service';
        }

        function extractParentResource(tags) {
            if (!tags) return null;
            const match = tags.match(/cm-resource-parent[:\s]*([^,;]+)/i);
            return match ? match[1].trim() : null;
        }

        async function generateHierarchicalPreview() {
            const totalOriginal = Object.values(hierarchicalData).reduce((sum, rg) => sum + rg.totalOriginalCost, 0);
            const totalMarkup = Object.values(hierarchicalData).reduce((sum, rg) => sum + rg.totalMarkupAmount, 0);
            const totalFinal = Object.values(hierarchicalData).reduce((sum, rg) => sum + rg.totalCost, 0);
            const totalRecords = processedData.length;

            // Track preview usage before generating preview
            try {
                if (currentUser) {
                    const trackPreviewUsage = firebase.functions().httpsCallable('trackPreviewUsage');
                    const result = await trackPreviewUsage({
                        rowCount: totalRecords,
                        documentCount: 1
                    });

                    console.log('Preview usage tracked:', result.data);

                    // Update usage display if it exists
                    if (window.updateUsageDisplay) {
                        window.updateUsageDisplay(result.data.usage);
                    }
                } else {
                    // This should never happen since login is required, but just in case
                    alert('Please sign in to generate previews');
                    return;
                }
            } catch (error) {
                console.error('Error tracking preview usage:', error);

                // Handle usage limit errors
                if (error.code === 'functions/resource-exhausted' || error.code === 'functions/invalid-argument') {
                    alert(`Usage Limit Reached: ${error.message}`);
                    return; // Don't generate preview if limits exceeded
                }

                // For other errors, continue with preview but log the error
                console.warn('Preview usage tracking failed, continuing with preview generation');
            }

            const previewHtml = `
                <div class="summary-stats">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-value">${totalRecords.toLocaleString()}</div>
                                <div class="stat-label">Total Records</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-value">${selectedCurrencySymbol}${totalOriginal.toFixed(2)}</div>
                                <div class="stat-label">Original Cost</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-value">${selectedCurrencySymbol}${totalMarkup.toFixed(2)}</div>
                                <div class="stat-label">Markup Amount</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-value">${selectedCurrencySymbol}${totalFinal.toFixed(2)}</div>
                                <div class="stat-label">Final Cost</div>
                            </div>
                        </div>
                    </div>
                </div>

                <h6><i class="fas fa-sitemap me-2"></i>Hierarchical Resource View</h6>
                <p class="text-muted mb-3">Click on items to expand/collapse and view dependencies</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Account Manager Preview:</strong> This preview shows markup details for internal use. The final customer report will only show final costs without markup information.
                </div>

                <div class="resource-hierarchy">
                    ${generateNativeTreeHTML(hierarchicalData)}
                </div>
            `;

            document.getElementById('previewContent').innerHTML = previewHtml;
        }

        function generateNativeTreeHTML(hierarchy) {
            let html = '';

            Object.values(hierarchy).forEach(topLevel => {
                // Handle both multi-customer and single-customer scenarios
                const resources = topLevel.resources || {};
                const hasChildren = Object.keys(resources).length > 0;
                const topLevelIcon = selectedBillingType === 'payg' ? 'fas fa-folder' : 'fas fa-user';
                const childrenLabel = selectedBillingType === 'payg' ? 'resources' : 'products';

                html += `
                    <details class="level-1">
                        <summary>
                            <div class="resource-info">
                                <div class="resource-details">
                                    <div class="resource-name">
                                        <i class="${topLevelIcon} me-2"></i>${topLevel.name}
                                    </div>
                                    <div class="resource-type">${topLevel.type} ‚Ä¢ ${Object.keys(topLevel.resources).length} ${childrenLabel} ‚Ä¢ ${topLevel.itemCount} billing items</div>
                                </div>
                                <div class="cost-info">
                                    <div class="cost-original">Original: ${selectedCurrencySymbol}${topLevel.totalOriginalCost.toFixed(2)}</div>
                                    <div class="cost-final">${selectedCurrencySymbol}${topLevel.totalCost.toFixed(2)}</div>
                                    <div class="cost-markup">+${selectedCurrencySymbol}${topLevel.totalMarkupAmount.toFixed(2)}</div>
                                </div>
                            </div>
                        </summary>
                        ${hasChildren ? `<div class="resource-content">${generateResourcesHTML(topLevel.resources)}</div>` : ''}
                    </details>
                `;
            });

            return html;
        }

        function generateResourcesHTML(resources) {
            let html = '';

            Object.values(resources).forEach(resource => {
                // For new RI structure, resources ARE products (no intermediate subscription level)
                // For PayG structure, resources have products
                const hasChildren = resource.products ? Object.keys(resource.products).length > 0 : resource.items && resource.items.length > 0;
                const resourceIcon = getResourceIcon(resource.type);

                // Different display for RI vs Pay-as-you-go
                let resourceDetails = '';
                if (selectedBillingType === 'ri') {
                    // New RI structure: resource IS the product
                    resourceDetails = `
                        <div class="resource-type">${resource.type}, ${resource.meterName || 'Unknown SKU'} ‚Ä¢ ${resource.itemCount} reservations</div>
                    `;
                } else {
                    // PayG structure: resource has products
                    resourceDetails = `
                        <div class="resource-type">${resource.type} ‚Ä¢ ${Object.keys(resource.products || {}).length} products ‚Ä¢ ${resource.itemCount} billing items</div>
                        ${resource.parentResource ? `<div class="resource-type"><small>Parent: ${resource.parentResource}</small></div>` : ''}
                    `;
                }

                html += `
                    <details class="level-2">
                        <summary>
                            <div class="resource-info">
                                <div class="resource-details">
                                    <div class="resource-name">
                                        <i class="${resourceIcon} me-2"></i>${resource.name}
                                    </div>
                                    ${resourceDetails}
                                </div>
                                <div class="cost-info">
                                    <div class="cost-original">Original: ${selectedCurrencySymbol}${resource.totalOriginalCost.toFixed(2)}</div>
                                    <div class="cost-final">${selectedCurrencySymbol}${resource.totalCost.toFixed(2)}</div>
                                    <div class="cost-markup">+${selectedCurrencySymbol}${resource.totalMarkupAmount.toFixed(2)}</div>
                                </div>
                            </div>
                        </summary>
                        ${hasChildren ? `<div class="resource-content">${selectedBillingType === 'ri' ? generateItemsHTML(resource.items) : generateProductsHTML(resource.products)}</div>` : ''}
                    </details>
                `;
            });

            return html;
        }

        function generateProductsHTML(products) {
            let html = '';

            Object.values(products).forEach(product => {
                const hasChildren = product.items.length > 0;

                html += `
                    <details class="level-3">
                        <summary>
                            <div class="resource-info">
                                <div class="resource-details">
                                    <div class="resource-name">
                                        <i class="fas fa-cube me-2"></i>${product.name}
                                    </div>
                                    <div class="resource-type">${product.meterName} ‚Ä¢ ${product.items.length} usage records</div>
                                </div>
                                <div class="cost-info">
                                    <div class="cost-original">Original: ${selectedCurrencySymbol}${product.totalOriginalCost.toFixed(2)}</div>
                                    <div class="cost-final">${selectedCurrencySymbol}${product.totalCost.toFixed(2)}</div>
                                    <div class="cost-markup">+${selectedCurrencySymbol}${product.totalMarkupAmount.toFixed(2)}</div>
                                </div>
                            </div>
                        </summary>
                        ${hasChildren ? `<div class="resource-content">${generateItemsHTML(product.items)}</div>` : ''}
                    </details>
                `;
            });

            return html;
        }

        function generateItemsHTML(items) {
            let html = '';

            items.forEach((item, index) => {
                // For RI items, show subscription context; for PayG items, show usage date
                const itemTitle = item.subscriptionId
                    ? `Reservation ${index + 1}`
                    : `Usage: ${item.usageDate}`;

                const itemInfo = item.subscriptionId
                    ? `Qty: ${item.quantity} @ ${selectedCurrencySymbol}${(parseFloat(item.unitPrice) || 0).toFixed(4)} | Subscription: ${item.subscriptionId.substring(0, 8)}...`
                    : `Qty: ${item.quantity} @ ${selectedCurrencySymbol}${(parseFloat(item.unitPrice) || 0).toFixed(4)} | Region: ${item.meterRegion || 'N/A'}`;

                html += `
                    <div class="meter-item level-4">
                        <div class="meter-details">
                            <div class="meter-name">${itemTitle}</div>
                            <div class="meter-info">${itemInfo}</div>
                        </div>
                        <div class="cost-info">
                            <div class="cost-original">Original: ${selectedCurrencySymbol}${item.originalCost.toFixed(2)}</div>
                            <div class="cost-final">${selectedCurrencySymbol}${item.finalCost.toFixed(2)}</div>
                            <div class="cost-markup">+${selectedCurrencySymbol}${item.markupAmount.toFixed(2)}</div>
                        </div>
                    </div>
                `;
            });

            return html;
        }

        function getResourceIcon(resourceType) {
            switch (resourceType) {
                case 'Virtual Machine': return 'fas fa-server';
                case 'Storage Disk': return 'fas fa-hdd';
                case 'Backup Service': return 'fas fa-shield-alt';
                case 'Network Service': return 'fas fa-network-wired';
                case 'Storage Service': return 'fas fa-database';
                case 'Subscription': return 'fas fa-credit-card';
                case 'Customer': return 'fas fa-user';
                default: return 'fas fa-cube';
            }
        }

        // Customer-facing tree HTML (no markup information)
        function generateCustomerTreeHTML(hierarchy) {
            let html = '';

            Object.values(hierarchy).forEach(topLevel => {
                const hasChildren = Object.keys(topLevel.resources).length > 0;
                const topLevelIcon = selectedBillingType === 'payg' ? 'fas fa-folder' : 'fas fa-user';
                const childrenLabel = selectedBillingType === 'payg' ? 'resources' : 'products';

                html += `
                    <details class="level-1">
                        <summary>
                            <div class="resource-info">
                                <div class="resource-details">
                                    <div class="resource-name">
                                        <i class="${topLevelIcon} me-2"></i>${topLevel.name}
                                    </div>
                                    <div class="resource-type">${topLevel.type} ‚Ä¢ ${Object.keys(topLevel.resources).length} ${childrenLabel} ‚Ä¢ ${topLevel.itemCount} billing items</div>
                                </div>
                                <div class="cost-info">
                                    <div class="cost-final">${selectedCurrencySymbol}${topLevel.totalCost.toFixed(2)}</div>
                                </div>
                            </div>
                        </summary>
                        ${hasChildren ? `<div class="resource-content">${generateCustomerResourcesHTML(topLevel.resources)}</div>` : ''}
                    </details>
                `;
            });

            return html;
        }

        function generateCustomerResourcesHTML(resources) {
            let html = '';

            Object.values(resources).forEach(resource => {
                // For new RI structure, resources ARE products (no intermediate subscription level)
                // For PayG structure, resources have products
                const hasChildren = resource.products ? Object.keys(resource.products).length > 0 : resource.items && resource.items.length > 0;
                const resourceIcon = getResourceIcon(resource.type);

                // Different display for RI vs Pay-as-you-go
                let resourceDetails = '';
                if (selectedBillingType === 'ri') {
                    // New RI structure: resource IS the product
                    resourceDetails = `
                        <div class="resource-type">${resource.type}, ${resource.meterName || 'Unknown SKU'} ‚Ä¢ ${resource.itemCount} reservations</div>
                    `;
                } else {
                    // PayG structure: resource has products
                    resourceDetails = `
                        <div class="resource-type">${resource.type} ‚Ä¢ ${Object.keys(resource.products || {}).length} products ‚Ä¢ ${resource.itemCount} billing items</div>
                        ${resource.parentResource ? `<div class="resource-type"><small>Parent: ${resource.parentResource}</small></div>` : ''}
                    `;
                }

                html += `
                    <details class="level-2">
                        <summary>
                            <div class="resource-info">
                                <div class="resource-details">
                                    <div class="resource-name">
                                        <i class="${resourceIcon} me-2"></i>${resource.name}
                                    </div>
                                    ${resourceDetails}
                                </div>
                                <div class="cost-info">
                                    <div class="cost-final">${selectedCurrencySymbol}${resource.totalCost.toFixed(2)}</div>
                                </div>
                            </div>
                        </summary>
                        ${hasChildren ? `<div class="resource-content">${selectedBillingType === 'ri' ? generateCustomerItemsHTML(resource.items) : generateCustomerProductsHTML(resource.products)}</div>` : ''}
                    </details>
                `;
            });

            return html;
        }

        function generateCustomerProductsHTML(products) {
            let html = '';

            Object.values(products).forEach(product => {
                const hasChildren = product.items.length > 0;

                html += `
                    <details class="level-3">
                        <summary>
                            <div class="resource-info">
                                <div class="resource-details">
                                    <div class="resource-name">
                                        <i class="fas fa-cube me-2"></i>${product.name}
                                    </div>
                                    <div class="resource-type">${product.meterName} ‚Ä¢ ${product.items.length} usage records</div>
                                </div>
                                <div class="cost-info">
                                    <div class="cost-final">${selectedCurrencySymbol}${product.totalCost.toFixed(2)}</div>
                                </div>
                            </div>
                        </summary>
                        ${hasChildren ? `<div class="resource-content">${generateCustomerItemsHTML(product.items)}</div>` : ''}
                    </details>
                `;
            });

            return html;
        }

        function generateCustomerItemsHTML(items) {
            let html = '';

            items.forEach((item, index) => {
                // For RI items, show subscription context; for PayG items, show usage date
                const itemTitle = item.subscriptionId
                    ? `Reservation ${index + 1}`
                    : `Usage: ${item.usageDate}`;

                const itemInfo = item.subscriptionId
                    ? `Qty: ${item.quantity} @ ${selectedCurrencySymbol}${(parseFloat(item.unitPrice) || 0).toFixed(4)} | Subscription: ${item.subscriptionId.substring(0, 8)}...`
                    : `Qty: ${item.quantity} @ ${selectedCurrencySymbol}${(parseFloat(item.unitPrice) || 0).toFixed(4)} | Region: ${item.meterRegion || 'N/A'}`;

                html += `
                    <div class="meter-item level-4">
                        <div class="meter-details">
                            <div class="meter-name">${itemTitle}</div>
                            <div class="meter-info">${itemInfo}</div>
                        </div>
                        <div class="cost-info">
                            <div class="cost-final">${selectedCurrencySymbol}${item.finalCost.toFixed(2)}</div>
                        </div>
                    </div>
                `;
            });

            return html;
        }

        function generateReport() {
            if (!hierarchicalData) {
                showError('Please process the data first.');
                return;
            }

            currentStep = 4;
            updateStepIndicator();
            showSection('generateSection');

            // Show loading
            document.getElementById('generateContent').innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5>Generating Hierarchical Report...</h5>
                    <p class="text-muted">Processing ${processedData.length.toLocaleString()} records</p>
                </div>
            `;

            // Simulate processing time
            setTimeout(() => {
                document.getElementById('generateContent').innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>Report Generated Successfully!</strong>
                        <p class="mb-0 mt-2">Your hierarchical Azure billing report is ready for preview and export.</p>
                    </div>

                    <div class="d-flex gap-2 justify-content-center flex-wrap">
                        <button type="button" class="btn btn-primary" onclick="previewReport()">
                            <i class="fas fa-eye me-2"></i>Preview Report
                        </button>
                        <button type="button" class="btn btn-success" onclick="exportReport()">
                            <i class="fas fa-download me-2"></i>Export HTML
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="exportPDF()" id="pdfExportBtn" style="display: none;">
                            <i class="fas fa-file-pdf me-2"></i>Export PDF
                        </button>
                        <button type="button" class="btn btn-info" onclick="showIndividualCustomerReports()">
                            <i class="fas fa-users me-2"></i>Individual Customer Reports
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="startOver()">
                            <i class="fas fa-redo me-2"></i>Start Over
                        </button>
                    </div>
                `;
            }, 2000);
        }

        function previewReport() {
            const reportHtml = generateReportHTML();
            document.getElementById('reportContent').innerHTML = reportHtml;
            document.getElementById('reportPreviewSection').classList.remove('hidden');
            document.getElementById('reportPreviewSection').classList.add('fade-in');
            document.getElementById('reportPreviewSection').scrollIntoView({ behavior: 'smooth' });
        }

        function generateReportHTML() {
            const totalOriginal = Object.values(hierarchicalData).reduce((sum, rg) => sum + rg.totalOriginalCost, 0);
            const totalMarkup = Object.values(hierarchicalData).reduce((sum, rg) => sum + rg.totalMarkupAmount, 0);
            const totalFinal = Object.values(hierarchicalData).reduce((sum, rg) => sum + rg.totalCost, 0);
            const totalRecords = processedData.length;
            const currentDate = new Date().toLocaleDateString();

            return `
                <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px;">
                    <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #007bff; padding-bottom: 20px;">
                        <h1 style="color: #333; margin-bottom: 10px;">
                            <i class="fas fa-sitemap" style="margin-right: 10px;"></i>${reportTitle}
                        </h1>
                        ${companyName ? `<h2 style="color: #666; font-weight: 300;">${companyName}</h2>` : ''}
                        <p style="color: #666; margin: 0;">Generated on ${currentDate}</p>
                    </div>

                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px; padding: 20px; margin-bottom: 30px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 15px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 600;">${totalRecords.toLocaleString()}</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Total Billing Records</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 15px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 600;">${Object.keys(hierarchicalData).length}</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Resource Groups</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 15px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 600;">${selectedCurrencySymbol}${totalFinal.toFixed(2)}</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Total Cost</div>
                            </div>
                        </div>
                    </div>

                    <h3 style="color: #333; margin-bottom: 15px;">
                        <i class="fas fa-sitemap" style="margin-right: 10px;"></i>Hierarchical Resource Breakdown
                    </h3>
                    <p style="color: #666; margin-bottom: 20px;">Native HTML collapsible interface - click to expand/collapse resource dependencies</p>

                    <div class="resource-hierarchy">
                        ${generateCustomerTreeHTML(hierarchicalData)}
                    </div>

                    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #dee2e6; text-align: center; color: #666; font-size: 0.9rem;">
                        <p>Report generated by Azure Billing Report Generator</p>
                        <p>Currency: ${selectedCurrency} (${selectedCurrencySymbol})</p>
                        <p>Professional Azure billing analysis and reporting</p>
                        ${!window.FEATURE_FLAGS.isLicensed ? '<p style="color: #dc3545; font-weight: bold; background: #fff3cd; padding: 10px; border-radius: 5px; margin-top: 15px;">DEMO VERSION - Not for client distribution</p>' : ''}
                        ${window.FEATURE_FLAGS.isLicensed && window.FEATURE_FLAGS.brandingEnabled ? '<p style="color: #28a745; font-size: 0.8rem; margin-top: 10px;"><i class="fas fa-certificate"></i> Licensed Version</p>' : ''}
                    </div>
                    ${!window.FEATURE_FLAGS.isLicensed ? '<div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 8rem; color: rgba(255, 0, 0, 0.05); font-weight: bold; pointer-events: none; z-index: 1000; user-select: none;">DEMO</div>' : ''}
                </div>
            `;
        }

        function exportReport() {
            if (!hierarchicalData) {
                showError('No report data available to export.');
                return;
            }

            const reportHtml = generateStandaloneReportHTML();
            const blob = new Blob([reportHtml], { type: 'text/html' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `Azure_Billing_Hierarchical_Report_${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportPDF() {
            if (!window.FEATURE_FLAGS || !window.FEATURE_FLAGS.PDF_EXPORT) {
                showError('PDF export is only available in the licensed version.');
                return;
            }

            if (!hierarchicalData) {
                showError('No report data available to export.');
                return;
            }

            // This would integrate with a PDF library like jsPDF or Puppeteer
            // For now, show a placeholder message
            showSuccess('PDF export functionality will be implemented in the licensed version with proper PDF generation libraries.');
        }

        function generateStandaloneReportHTML() {
            const reportContent = generateReportHTML();

            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${reportTitle} - ${companyName || 'Azure Billing Report'}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .resource-hierarchy { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        details { border: 1px solid #dee2e6; border-radius: 6px; margin-bottom: 0.5rem; background: #f8f9fa; }
        details[open] { background: #e3f2fd; border-color: #007bff; }
        summary { padding: 0.75rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; transition: all 0.3s; }
        summary:hover { background: rgba(0,123,255,0.1); }
        .resource-info { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .resource-details { flex-grow: 1; }
        .resource-name { font-weight: 600; color: #333; }
        .resource-type { font-size: 0.85em; color: #666; margin-top: 0.25rem; }
        .cost-info { text-align: right; min-width: 150px; margin-left: 1rem; }
        .cost-original { font-size: 0.85em; color: #666; }
        .cost-final { font-weight: 600; color: #28a745; font-size: 1.1em; }
        .cost-markup { font-size: 0.8em; color: #dc3545; }
        .resource-content { padding: 0 1rem 1rem 1rem; border-top: 1px solid #dee2e6; background: white; }
        .meter-item { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; padding: 0.5rem; margin-bottom: 0.25rem; display: flex; justify-content: space-between; align-items: center; }
        .meter-details { flex-grow: 1; }
        .meter-name { font-weight: 500; color: #495057; }
        .meter-info { font-size: 0.8em; color: #6c757d; }
        .level-1 { margin-left: 0; }
        .level-2 { margin-left: 1rem; }
        .level-3 { margin-left: 2rem; }
        .level-4 { margin-left: 3rem; }
    </style>
</head>
<body>
    ${reportContent}
</body>
</html>`;
        }

        function closeReportPreview() {
            document.getElementById('reportPreviewSection').classList.add('hidden');
        }

        function startOver() {
            // Reset all data
            uploadedData = null;
            processedData = null;
            hierarchicalData = null;
            currentStep = 1;
            globalMarkupPercent = 0;
            selectedCurrency = 'GBP';
            selectedCurrencySymbol = '¬£';
            companyName = '';
            reportTitle = 'Azure Billing Report';

            // Reset form inputs
            document.getElementById('fileInput').value = '';
            document.getElementById('globalMarkup').value = '0';
            document.getElementById('companyName').value = '';
            document.getElementById('reportTitle').value = 'Azure Billing Report';

            // Currency is fixed to GBP - no reset needed

            // Hide all sections except upload
            document.querySelectorAll('.card').forEach(card => card.classList.add('hidden'));
            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('reportPreviewSection').classList.add('hidden');

            // Reset step indicator
            updateStepIndicator();
        }

        function updateStepIndicator() {
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active', 'completed');
            });

            for (let i = 1; i <= 4; i++) {
                const step = document.getElementById(`step${i}`);
                if (i < currentStep) {
                    step.classList.add('completed');
                } else if (i === currentStep) {
                    step.classList.add('active');
                }
            }
        }

        function showSection(sectionId) {
            document.querySelectorAll('.card').forEach(card => card.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
            document.getElementById(sectionId).classList.add('fade-in');
        }

        function showError(message) {
            // Create or update error alert
            let errorAlert = document.getElementById('errorAlert');
            if (!errorAlert) {
                errorAlert = document.createElement('div');
                errorAlert.id = 'errorAlert';
                errorAlert.className = 'alert alert-danger alert-dismissible fade show';
                errorAlert.setAttribute('role', 'alert');
                errorAlert.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="errorMessage"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                document.querySelector('.container').prepend(errorAlert);
            }

            document.getElementById('errorMessage').textContent = message;
            errorAlert.classList.remove('hidden');
            errorAlert.classList.add('fade-in');

            // Auto-hide after 5 seconds
            setTimeout(() => {
                errorAlert.style.display = 'none';
            }, 5000);
        }

        // Individual Customer Reports Functions
        function showIndividualCustomerReports() {
            if (!hierarchicalData) {
                showError('Please process the data first.');
                return;
            }

            // Get list of customers
            const customers = Object.keys(hierarchicalData);

            if (customers.length === 0) {
                showError('No customers found in the data.');
                return;
            }

            // Show the individual reports section
            document.getElementById('individualReportsSection').classList.remove('hidden');
            document.getElementById('individualReportsSection').classList.add('fade-in');

            // Generate customer selection interface
            let html = `
                <div class="mb-4">
                    <h6><i class="fas fa-info-circle me-2"></i>Select Customers for Individual Reports</h6>
                    <p class="text-muted">Choose which customers you want to generate individual reports for. Each customer will get their own HTML report file.</p>
                </div>

                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">Available Customers (${customers.length})</h6>
                                <div>
                                    <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="selectAllCustomers()">
                                        <i class="fas fa-check-square me-1"></i>Select All
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllCustomers()">
                                        <i class="fas fa-square me-1"></i>Deselect All
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
            `;

            customers.forEach((customerName, index) => {
                const customer = hierarchicalData[customerName];
                const resourceCount = Object.keys(customer.resources).length;
                const itemCount = customer.itemCount;

                html += `
                    <div class="col-md-6 mb-3">
                        <div class="form-check">
                            <input class="form-check-input customer-checkbox" type="checkbox" value="${customerName}" id="customer_${index}" checked>
                            <label class="form-check-label" for="customer_${index}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <strong>${customerName}</strong>
                                        <br>
                                        <small class="text-muted">
                                            ${resourceCount} ${selectedBillingType === 'payg' ? 'resources' : 'products'} ‚Ä¢ ${itemCount} items ‚Ä¢ ${selectedCurrencySymbol}${customer.totalCost.toFixed(2)}
                                        </small>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                `;
            });

            html += `
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-download me-2"></i>Generate Reports</h6>
                            </div>
                            <div class="card-body text-center">
                                <p class="text-muted small mb-3">Selected customers will be exported as individual HTML reports in a ZIP file.</p>
                                <button type="button" class="btn btn-success" onclick="generateIndividualReports()">
                                    <i class="fas fa-file-archive me-2"></i>Download ZIP
                                </button>
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <i class="fas fa-shield-alt me-1"></i>
                                        Customer reports hide markup information
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('individualReportsContent').innerHTML = html;
            document.getElementById('individualReportsSection').scrollIntoView({ behavior: 'smooth' });
        }

        function selectAllCustomers() {
            document.querySelectorAll('.customer-checkbox').forEach(checkbox => {
                checkbox.checked = true;
            });
        }

        function deselectAllCustomers() {
            document.querySelectorAll('.customer-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        function closeIndividualReports() {
            document.getElementById('individualReportsSection').classList.add('hidden');
        }

        async function generateIndividualReports() {
            // Get selected customers
            const selectedCustomers = [];
            document.querySelectorAll('.customer-checkbox:checked').forEach(checkbox => {
                selectedCustomers.push(checkbox.value);
            });

            if (selectedCustomers.length === 0) {
                showError('Please select at least one customer.');
                return;
            }

            // Show loading state
            const generateBtn = document.querySelector('button[onclick="generateIndividualReports()"]');
            const originalText = generateBtn.innerHTML;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
            generateBtn.disabled = true;

            try {
                // Create ZIP file
                const zip = new JSZip();

                // Generate report for each selected customer
                for (const customerName of selectedCustomers) {
                    const customerHierarchy = {
                        [customerName]: hierarchicalData[customerName]
                    };

                    const customerReportHTML = generateCustomerReportHTML(customerHierarchy, customerName);
                    const fileName = `${customerName.replace(/[^a-zA-Z0-9]/g, '_')}_Azure_Billing_Report.html`;
                    zip.file(fileName, customerReportHTML);
                }

                // Generate ZIP and download
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Azure_Individual_Customer_Reports_${new Date().toISOString().split('T')[0]}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // Show success message
                showSuccess(`Successfully generated ${selectedCustomers.length} individual customer reports!`);

            } catch (error) {
                console.error('Error generating individual reports:', error);
                showError('Failed to generate individual reports. Please try again.');
            } finally {
                // Restore button
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;
            }
        }

        function generateCustomerReportHTML(customerHierarchy, customerName) {
            const customer = customerHierarchy[customerName];
            const totalRecords = customer.itemCount;
            const totalCost = customer.totalCost;
            const currentDate = new Date().toLocaleDateString();
            const resourceCount = Object.keys(customer.resources).length;

            return `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${customerName} - Azure Billing Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .resource-hierarchy { margin-top: 20px; }
        .level-1, .level-2, .level-3 { margin-bottom: 10px; }
        .level-1 > summary { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6; }
        .level-2 > summary { background: #ffffff; padding: 12px; border-radius: 6px; border: 1px solid #e9ecef; margin-left: 20px; }
        .level-3 > summary { background: #f8f9fa; padding: 10px; border-radius: 4px; border: 1px solid #f1f3f4; margin-left: 40px; }
        .resource-info { display: flex; justify-content: between; align-items: center; }
        .resource-details { flex: 1; }
        .resource-name { font-weight: 600; color: #333; }
        .resource-type { font-size: 0.9em; color: #666; margin-top: 4px; }
        .cost-info { text-align: right; }
        .cost-final { font-weight: 600; color: #28a745; font-size: 1.1em; }
        .resource-content { margin-top: 10px; }
        .item-info { display: flex; justify-content: between; align-items: center; padding: 8px 12px; background: #f8f9fa; border-radius: 4px; margin: 5px 0; margin-left: 60px; }
        .item-details { flex: 1; }
        .item-name { font-weight: 500; color: #333; }
        .item-description { font-size: 0.85em; color: #666; margin-top: 2px; }
        .item-cost { text-align: right; font-weight: 600; color: #28a745; }
    </style>
</head>
<body>
    <div class="container my-5">
        <div class="text-center mb-5 border-bottom pb-4">
            <h1 class="text-primary mb-3">
                <i class="fas fa-sitemap me-3"></i>${reportTitle}
            </h1>
            ${companyName ? `<h2 class="text-secondary fw-light">${companyName}</h2>` : ''}
            <h3 class="text-dark">${customerName}</h3>
            <p class="text-muted">Generated on ${currentDate}</p>
        </div>

        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h4 class="text-primary">${totalRecords}</h4>
                        <small class="text-muted">Total Billing Records</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h4 class="text-info">${resourceCount}</h4>
                        <small class="text-muted">${selectedBillingType === 'payg' ? 'Resource Groups' : 'Products'}</small>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card text-center">
                    <div class="card-body">
                        <h4 class="text-success">${selectedCurrencySymbol}${totalCost.toFixed(2)}</h4>
                        <small class="text-muted">Total Cost</small>
                    </div>
                </div>
            </div>
        </div>

        <h3 class="mb-3">
            <i class="fas fa-sitemap me-2"></i>Hierarchical Resource Breakdown
        </h3>
        <p class="text-muted mb-4">Native HTML collapsible interface - click to expand/collapse resource dependencies</p>

        <div class="resource-hierarchy">
            ${generateCustomerTreeHTML(customerHierarchy)}
        </div>

        <div class="mt-5 pt-4 border-top text-center text-muted">
            <p class="mb-1">Report generated by Azure Billing Report Generator</p>
            <p class="mb-1">Currency: ${selectedCurrencySymbol === '¬£' ? 'GBP (¬£)' : selectedCurrencySymbol}</p>
            <p class="mb-0">Professional Azure billing analysis and reporting</p>
        </div>
    </div>
</body>
</html>`;
        }

        function showSuccess(message) {
            const successAlert = document.getElementById('successAlert');
            if (successAlert) {
                successAlert.querySelector('.alert-message').textContent = message;
                successAlert.classList.remove('hidden');
                successAlert.classList.add('fade-in');

                // Auto-hide after 5 seconds
                setTimeout(() => {
                    successAlert.style.display = 'none';
                }, 5000);
            } else {
                // Create success alert if it doesn't exist
                const alertHtml = `
                    <div id="successAlert" class="alert alert-success alert-dismissible fade-in" role="alert">
                        <i class="fas fa-check-circle me-2"></i>
                        <span class="alert-message">${message}</span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                document.querySelector('.container').insertAdjacentHTML('afterbegin', alertHtml);

                // Auto-hide after 5 seconds
                setTimeout(() => {
                    const alert = document.getElementById('successAlert');
                    if (alert) alert.style.display = 'none';
                }, 5000);
            }
        }

        // Initialize feature flags and UI
        function initializeFeatureFlags() {
            // Default feature flags (will be overridden by build system)
            if (!window.FEATURE_FLAGS) {
                window.FEATURE_FLAGS = {
                    MAX_ROWS: -1, // unlimited by default
                    PDF_EXPORT: false,
                    WHITELABEL_BRANDING: false,
                    WATERMARK: false,
                    INDIVIDUAL_REPORTS: true,
                    MARKUP_TOOLS: true,
                    CSV_SUPPORT: true,
                    HIERARCHICAL_GROUPING: true,
                    AUTO_DETECTION: true
                };
            }

            // Show/hide PDF export button based on feature flags
            const pdfBtn = document.getElementById('pdfExportBtn');
            if (pdfBtn && window.FEATURE_FLAGS.PDF_EXPORT) {
                pdfBtn.style.display = 'inline-block';
            }

            // Apply branding placeholders for whitelabel support
            if (window.FEATURE_FLAGS.WHITELABEL_BRANDING) {
                // Add company name placeholders that will be replaced by license system
                const title = document.querySelector('h1');
                if (title && !title.querySelector('.company-name-placeholder')) {
                    const placeholder = document.createElement('span');
                    placeholder.className = 'company-name-placeholder';
                    placeholder.textContent = 'Azure Billing Report Generator';
                    title.innerHTML = '<i class="fas fa-chart-line me-3"></i>' + placeholder.outerHTML;
                }
            }

            console.log('üöÄ Feature flags initialized:', window.FEATURE_FLAGS);
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeFeatureFlags);
        } else {
            initializeFeatureFlags();
        }
    </script>

    <!-- Individual Customer Reports Section -->
    <div class="card hidden mt-4" id="individualReportsSection">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-users me-2"></i>Individual Customer Reports</h5>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="closeIndividualReports()">
                <i class="fas fa-times me-2"></i>Close
            </button>
        </div>
        <div class="card-body">
            <div id="individualReportsContent">
                <!-- Individual reports content will be populated here -->
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-5 py-4 bg-light border-top">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <p class="mb-0 text-muted small">
                        <i class="fas fa-code me-1"></i>
                        Made by <strong>Rodrigo Quintian</strong> ‚Ä¢
                        Licensed under <a href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank"
                            class="text-decoration-none">Apache 2.0</a>
                    </p>
                </div>
                <div class="col-md-4 text-md-end">
                    <a href="https://github.com/cafasdon/azurebillreport" target="_blank"
                        class="btn btn-outline-secondary btn-sm">
                        <i class="fab fa-github me-1"></i>View on GitHub
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Pricing Modal -->
    <div class="modal fade" id="pricingModal" tabindex="-1" aria-labelledby="pricingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pricingModalLabel">
                        <i class="fas fa-shopping-cart me-2"></i>Choose Your Plan
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-4">
                        <!-- Starter Plan -->
                        <div class="col-md-4">
                            <div class="card h-100 border-primary">
                                <div class="card-header bg-primary text-white text-center">
                                    <h6 class="mb-0">Starter</h6>
                                </div>
                                <div class="card-body text-center">
                                    <div class="display-6 fw-bold text-primary">¬£19.99</div>
                                    <small class="text-muted">per month</small>
                                    <hr>
                                    <ul class="list-unstyled">
                                        <li><i class="fas fa-check text-success me-2"></i>25 reports/month</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Up to 10,000 rows</li>
                                        <li><i class="fas fa-check text-success me-2"></i>7-day free trial</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Email support</li>
                                        <li><i class="fas fa-times text-muted me-2"></i>Custom branding</li>
                                    </ul>
                                </div>
                                <div class="card-footer">
                                    <button class="btn btn-primary w-100" onclick="startCheckout('starter')">
                                        <i class="fas fa-rocket me-2"></i>Start Free Trial
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Professional Plan -->
                        <div class="col-md-4">
                            <div class="card h-100 border-success position-relative">
                                <div class="position-absolute top-0 start-50 translate-middle">
                                    <span class="badge bg-success">Most Popular</span>
                                </div>
                                <div class="card-header bg-success text-white text-center">
                                    <h6 class="mb-0">Professional</h6>
                                </div>
                                <div class="card-body text-center">
                                    <div class="display-6 fw-bold text-success">¬£49.99</div>
                                    <small class="text-muted">per month</small>
                                    <hr>
                                    <ul class="list-unstyled">
                                        <li><i class="fas fa-check text-success me-2"></i>100 reports/month</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Up to 100,000 rows</li>
                                        <li><i class="fas fa-check text-success me-2"></i>7-day free trial</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Priority email support</li>
                                        <li><i class="fas fa-times text-muted me-2"></i>Custom branding</li>
                                    </ul>
                                </div>
                                <div class="card-footer">
                                    <button class="btn btn-success w-100" onclick="startCheckout('professional')">
                                        <i class="fas fa-rocket me-2"></i>Start Free Trial
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Enterprise Plan -->
                        <div class="col-md-4">
                            <div class="card h-100 border-warning">
                                <div class="card-header bg-warning text-dark text-center">
                                    <h6 class="mb-0">Enterprise</h6>
                                </div>
                                <div class="card-body text-center">
                                    <div class="display-6 fw-bold text-warning">¬£149.99</div>
                                    <small class="text-muted">per month</small>
                                    <hr>
                                    <ul class="list-unstyled">
                                        <li><i class="fas fa-check text-success me-2"></i>Unlimited reports</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Unlimited rows</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Custom branding</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Phone & email support</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Priority support</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Advanced reporting features
                                        </li>
                                    </ul>
                                </div>
                                <div class="card-footer">
                                    <button class="btn btn-warning w-100" onclick="startCheckout('enterprise')">
                                        <i class="fas fa-crown me-2"></i>Subscribe Now
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <small class="text-muted">
                            <i class="fas fa-shield-alt me-1"></i>Secure payment powered by Stripe ‚Ä¢
                            <i class="fas fa-sync-alt me-1"></i>Cancel anytime ‚Ä¢
                            <i class="fas fa-credit-card me-1"></i>All major cards accepted
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loginModalLabel">
                        <i class="fas fa-sign-in-alt me-2"></i>Sign In to Continue
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="mb-4">Please sign in to purchase a subscription and access your account.</p>

                    <div class="d-grid gap-3">
                        <button type="button" class="btn btn-danger btn-lg" onclick="signInWithGoogle()">
                            <i class="fab fa-google me-2"></i>Continue with Google
                        </button>
                    </div>

                    <hr class="my-4">

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <input type="email" class="form-control" id="emailInput" placeholder="Email address">
                        </div>
                        <div class="col-md-6 mb-3">
                            <input type="password" class="form-control" id="passwordInput" placeholder="Password">
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-success" onclick="signInWithEmail()">
                            <i class="fas fa-envelope me-2"></i>Sign In with Email
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="signUpWithEmail()">
                            <i class="fas fa-user-plus me-2"></i>Create Account
                        </button>
                    </div>

                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-shield-alt me-1"></i>Your data is secure and never shared with third
                            parties
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="profileModalLabel">
                        <i class="fas fa-user me-2"></i>Account Profile
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="profileContent">
                        <!-- Profile content will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Dashboard Modal -->
    <div class="modal fade" id="userDashboardModal" tabindex="-1" aria-labelledby="userDashboardModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userDashboardModalLabel">
                        <i class="fas fa-user-circle me-2"></i>Account Dashboard
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Dashboard Navigation -->
                    <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="profile-tab" data-bs-toggle="tab"
                                data-bs-target="#profile" type="button" role="tab">
                                <i class="fas fa-user me-1"></i>Profile
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="subscription-tab" data-bs-toggle="tab"
                                data-bs-target="#subscription" type="button" role="tab">
                                <i class="fas fa-credit-card me-1"></i>Subscription
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="billing-tab" data-bs-toggle="tab" data-bs-target="#billing"
                                type="button" role="tab">
                                <i class="fas fa-receipt me-1"></i>Billing History
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="usage-tab" data-bs-toggle="tab" data-bs-target="#usage"
                                type="button" role="tab">
                                <i class="fas fa-chart-bar me-1"></i>Usage
                            </button>
                        </li>
                    </ul>

                    <!-- Dashboard Content -->
                    <div class="tab-content mt-3" id="dashboardTabContent">
                        <!-- Profile Tab -->
                        <div class="tab-pane fade show active" id="profile" role="tabpanel">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6>Profile Information</h6>
                                    <form id="profileForm">
                                        <div class="mb-3">
                                            <label for="displayName" class="form-label">Display Name</label>
                                            <input type="text" class="form-control" id="displayName"
                                                placeholder="Your display name">
                                        </div>
                                        <div class="mb-3">
                                            <label for="email" class="form-label">Email Address</label>
                                            <input type="email" class="form-control" id="email" readonly>
                                            <div class="form-text">Email cannot be changed. Contact support if needed.
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="currentPassword" class="form-label">Current Password</label>
                                            <input type="password" class="form-control" id="currentPassword"
                                                placeholder="Enter current password to change">
                                        </div>
                                        <div class="mb-3">
                                            <label for="newPassword" class="form-label">New Password</label>
                                            <input type="password" class="form-control" id="newPassword"
                                                placeholder="Enter new password (optional)">
                                        </div>
                                        <div class="mb-3">
                                            <label for="confirmPassword" class="form-label">Confirm New Password</label>
                                            <input type="password" class="form-control" id="confirmPassword"
                                                placeholder="Confirm new password">
                                        </div>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save me-1"></i>Update Profile
                                        </button>
                                    </form>
                                </div>
                                <div class="col-md-4">
                                    <h6>Account Status</h6>
                                    <div id="accountStatus" class="card">
                                        <div class="card-body">
                                            <div id="emailVerificationStatus"></div>
                                            <div id="accountCreatedDate"></div>
                                            <div id="lastLoginDate"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Subscription Tab -->
                        <div class="tab-pane fade" id="subscription" role="tabpanel">
                            <div id="subscriptionDetails">
                                <!-- Subscription details will be loaded here -->
                            </div>
                        </div>

                        <!-- Billing History Tab -->
                        <div class="tab-pane fade" id="billing" role="tabpanel">
                            <div id="billingHistory">
                                <!-- Billing history will be loaded here -->
                            </div>
                        </div>

                        <!-- Usage Tab -->
                        <div class="tab-pane fade" id="usage" role="tabpanel">
                            <div id="usageStats">
                                <!-- Usage statistics will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger" onclick="confirmSignOut()">
                        <i class="fas fa-sign-out-alt me-1"></i>Sign Out
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stripe JavaScript -->
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-functions-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC9zLtb4fGlVap0M9BHRgFZCbcswDl0fhg",
            authDomain: "azure-billing-generator.firebaseapp.com",
            projectId: "azure-billing-generator",
            storageBucket: "azure-billing-generator.firebasestorage.app",
            messagingSenderId: "349336559465",
            appId: "1:349336559465:web:f23350ef9c9f76f75067f8"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const functions = firebase.functions();
        const db = firebase.firestore();

        // Stripe integration
        let currentUser = null;
        let subscriptionListener = null;

        // Authentication state listener
        auth.onAuthStateChanged(async (user) => {
            currentUser = user;
            if (user) {
                console.log('User signed in:', user.email);

                // Hide login wall and show main application
                hideLoginWall();

                // Check if email is verified
                if (!user.emailVerified) {
                    console.log('Email not verified for user:', user.email);
                    showEmailVerificationWall(user);
                    return;
                }

                updateUIForAuthenticatedUser(user);
                await checkSubscriptionStatus();
                await updateCustomerProfile(user);

                // Set up real-time subscription listener
                setupSubscriptionListener(user.uid);
            } else {
                console.log('User signed out');

                // Show login wall and hide main application
                showLoginWall();

                // Clean up subscription listener
                if (subscriptionListener) {
                    subscriptionListener();
                    subscriptionListener = null;
                }

                updateUIForAnonymousUser();
            }
        });

        // Login Wall Functions
        async function signInWithEmailFromWall() {
            const email = document.getElementById('loginWallEmail').value;
            const password = document.getElementById('loginWallPassword').value;

            if (!email || !password) {
                alert('Please enter both email and password');
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
                // Success handled by auth state listener
            } catch (error) {
                console.error('Sign in error:', error);
                alert(`Sign in failed: ${error.message}`);
            }
        }

        async function createAccountFromWall() {
            const email = document.getElementById('loginWallEmail').value;
            const password = document.getElementById('loginWallPassword').value;

            if (!email || !password) {
                alert('Please enter both email and password');
                return;
            }

            if (password.length < 6) {
                alert('Password must be at least 6 characters long');
                return;
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);

                // Send email verification
                await userCredential.user.sendEmailVerification();
                alert('Account created! Please check your email for verification link.');

                // Success handled by auth state listener
            } catch (error) {
                console.error('Account creation error:', error);
                alert(`Account creation failed: ${error.message}`);
            }
        }

        function showLoginWall() {
            document.getElementById('loginWall').style.display = 'flex';
            document.getElementById('mainApplication').style.display = 'none';
        }

        function hideLoginWall() {
            document.getElementById('loginWall').style.display = 'none';
            document.getElementById('mainApplication').style.display = 'block';
        }

        // Email Verification Wall Functions
        function showEmailVerificationWall(user) {
            document.getElementById('loginWall').style.display = 'none';
            document.getElementById('mainApplication').style.display = 'none';
            document.getElementById('emailVerificationWall').style.display = 'flex';

            // Update email address in the wall
            const emailElement = document.getElementById('verificationEmailAddress');
            if (emailElement) {
                emailElement.textContent = user.email;
            }
        }

        function hideEmailVerificationWall() {
            document.getElementById('emailVerificationWall').style.display = 'none';
            document.getElementById('mainApplication').style.display = 'block';
        }

        async function checkEmailVerificationStatus() {
            try {
                if (currentUser) {
                    await currentUser.reload();
                    if (currentUser.emailVerified) {
                        console.log('Email verified successfully!');
                        hideEmailVerificationWall();
                        updateUIForAuthenticatedUser(currentUser);
                        await checkSubscriptionStatus();
                        await updateCustomerProfile(currentUser);
                        setupSubscriptionListener(currentUser.uid);
                    } else {
                        alert('Email not yet verified. Please check your inbox and click the verification link.');
                    }
                }
            } catch (error) {
                console.error('Error checking email verification:', error);
                alert('Error checking verification status. Please try again.');
            }
        }

        async function resendVerificationEmailFromWall() {
            try {
                if (currentUser) {
                    await currentUser.sendEmailVerification({
                        url: window.location.origin + '?emailVerified=true',
                        handleCodeInApp: false
                    });

                    alert('Verification email sent! Please check your inbox.');
                } else {
                    alert('No user found. Please sign in again.');
                }
            } catch (error) {
                console.error('Error resending verification email:', error);
                alert('Error sending verification email. Please try again.');
            }
        }

        function signOutFromVerificationWall() {
            signOut();
        }

        // Authentication functions
        async function signInWithGoogle() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');
                await auth.signInWithPopup(provider);
                hideLoginModal();
            } catch (error) {
                console.error('Google sign-in error:', error);
                alert('Sign-in failed. Please try again.');
            }
        }



        async function signInWithEmail() {
            try {
                const email = document.getElementById('emailInput').value;
                const password = document.getElementById('passwordInput').value;

                if (!email || !password) {
                    alert('Please enter both email and password.');
                    return;
                }

                await auth.signInWithEmailAndPassword(email, password);
                hideLoginModal();
            } catch (error) {
                console.error('Email sign-in error:', error);
                alert('Sign-in failed: ' + error.message);
            }
        }

        async function signUpWithEmail() {
            try {
                const email = document.getElementById('emailInput').value;
                const password = document.getElementById('passwordInput').value;

                if (!email || !password) {
                    alert('Please enter both email and password.');
                    return;
                }

                if (password.length < 6) {
                    alert('Password must be at least 6 characters long.');
                    return;
                }

                // Create user account
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Send email verification
                await user.sendEmailVerification({
                    url: window.location.origin + '?emailVerified=true',
                    handleCodeInApp: false
                });

                hideLoginModal();

                // Show verification message
                showEmailVerificationMessage(email);

            } catch (error) {
                console.error('Email sign-up error:', error);
                alert('Sign-up failed: ' + error.message);
            }
        }

        async function signOut() {
            try {
                await auth.signOut();
                location.reload(); // Refresh page to reset state
            } catch (error) {
                console.error('Sign-out error:', error);
            }
        }

        // Email verification functions
        function showEmailVerificationMessage(email) {
            const message = `
                <div class="alert alert-info alert-dismissible fade show" role="alert">
                    <h5><i class="fas fa-envelope-open-text me-2"></i>Email Verification Required</h5>
                    <p>We've sent a verification email to <strong>${email}</strong>.</p>
                    <p>Please check your inbox and click the verification link to activate your account.</p>
                    <div class="mt-3">
                        <button type="button" class="btn btn-primary btn-sm" onclick="resendVerificationEmail()">
                            <i class="fas fa-paper-plane me-1"></i>Resend Email
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="checkEmailVerification()">
                            <i class="fas fa-check me-1"></i>I've Verified My Email
                        </button>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            // Insert at the top of the main content
            const mainContent = document.querySelector('.container-fluid');
            if (mainContent) {
                mainContent.insertAdjacentHTML('afterbegin', message);
            }
        }

        // Legacy function - now redirects to verification wall
        function showEmailVerificationRequired(user) {
            showEmailVerificationWall(user);
        }

        async function resendVerificationEmail() {
            try {
                if (currentUser) {
                    await currentUser.sendEmailVerification({
                        url: window.location.origin + '?emailVerified=true',
                        handleCodeInApp: false
                    });

                    // Show success message
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-success alert-dismissible fade show mt-3';
                    alert.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>Verification email sent successfully!
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;

                    const container = document.querySelector('.container-fluid');
                    if (container) {
                        container.insertAdjacentElement('afterbegin', alert);
                    }
                }
            } catch (error) {
                console.error('Error resending verification email:', error);
                alert('Failed to resend verification email: ' + error.message);
            }
        }

        async function checkEmailVerification() {
            try {
                if (currentUser) {
                    await currentUser.reload();
                    if (currentUser.emailVerified) {
                        location.reload(); // Refresh to update UI
                    } else {
                        alert('Email not yet verified. Please check your inbox and click the verification link.');
                    }
                }
            } catch (error) {
                console.error('Error checking email verification:', error);
                alert('Failed to check verification status: ' + error.message);
            }
        }

        // Modal management
        function showPricingModal() {
            const modal = new bootstrap.Modal(document.getElementById('pricingModal'));
            modal.show();
        }

        function showLoginModal() {
            // Redirect to login wall by signing out (which will show the login wall)
            signOut();
        }

        function hideLoginModal() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
            if (modal) modal.hide();
        }

        function showProfileModal() {
            updateProfileModal();
            const modal = new bootstrap.Modal(document.getElementById('profileModal'));
            modal.show();
        }

        // Show user dashboard
        function showUserDashboard() {
            loadDashboardData();
            const modal = new bootstrap.Modal(document.getElementById('userDashboardModal'));
            modal.show();
        }

        // Load dashboard data
        async function loadDashboardData() {
            if (!currentUser) return;

            // Load profile data
            loadProfileData();

            // Load subscription data
            loadSubscriptionData();

            // Load billing history
            loadBillingHistory();

            // Load usage statistics
            loadUsageStats();
        }

        // Load profile data
        function loadProfileData() {
            if (!currentUser) return;

            // Populate profile form
            document.getElementById('displayName').value = currentUser.displayName || '';
            document.getElementById('email').value = currentUser.email || '';

            // Update account status
            const emailVerificationStatus = document.getElementById('emailVerificationStatus');
            emailVerificationStatus.innerHTML = `
                <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-${currentUser.emailVerified ? 'check-circle text-success' : 'exclamation-triangle text-warning'} me-2"></i>
                    <span>Email ${currentUser.emailVerified ? 'Verified' : 'Not Verified'}</span>
                </div>
            `;

            const accountCreatedDate = document.getElementById('accountCreatedDate');
            if (currentUser.metadata && currentUser.metadata.creationTime) {
                accountCreatedDate.innerHTML = `
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-calendar-plus me-2"></i>
                        <span>Created: ${new Date(currentUser.metadata.creationTime).toLocaleDateString()}</span>
                    </div>
                `;
            }

            const lastLoginDate = document.getElementById('lastLoginDate');
            if (currentUser.metadata && currentUser.metadata.lastSignInTime) {
                lastLoginDate.innerHTML = `
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-clock me-2"></i>
                        <span>Last login: ${new Date(currentUser.metadata.lastSignInTime).toLocaleDateString()}</span>
                    </div>
                `;
            }
        }

        // Load subscription data
        async function loadSubscriptionData() {
            const subscriptionDetails = document.getElementById('subscriptionDetails');
            subscriptionDetails.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';

            try {
                const subscription = await checkSubscriptionStatus();

                if (subscription && subscription.hasSubscription) {
                    subscriptionDetails.innerHTML = `
                        <div class="row">
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-credit-card me-2"></i>Current Subscription</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-sm-6">
                                                <strong>Plan:</strong> ${subscription.plan.charAt(0).toUpperCase() + subscription.plan.slice(1)}
                                            </div>
                                            <div class="col-sm-6">
                                                <strong>Status:</strong>
                                                <span class="badge bg-${subscription.status === 'active' ? 'success' : 'warning'}">${subscription.status}</span>
                                            </div>
                                            <div class="col-sm-6 mt-2">
                                                <strong>Current Period:</strong> ${new Date(subscription.currentPeriodStart.seconds * 1000).toLocaleDateString()}
                                            </div>
                                            <div class="col-sm-6 mt-2">
                                                <strong>Next Billing:</strong> ${new Date(subscription.currentPeriodEnd.seconds * 1000).toLocaleDateString()}
                                            </div>
                                        </div>
                                        <hr>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-primary" onclick="openCustomerPortal()">
                                                <i class="fas fa-cog me-1"></i>Manage Subscription
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="cancelSubscription()">
                                                <i class="fas fa-times me-1"></i>Cancel Subscription
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-star me-2"></i>Plan Features</h6>
                                    </div>
                                    <div class="card-body">
                                        <ul class="list-unstyled">
                                            <li><i class="fas fa-check text-success me-2"></i>Unlimited Reports</li>
                                            <li><i class="fas fa-check text-success me-2"></i>Custom Branding</li>
                                            <li><i class="fas fa-check text-success me-2"></i>Priority Support</li>
                                            <li><i class="fas fa-check text-success me-2"></i>Advanced Analytics</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    subscriptionDetails.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                            <h5>No Active Subscription</h5>
                            <p class="text-muted">Upgrade to unlock unlimited reports and premium features.</p>
                            <button class="btn btn-primary" onclick="showPricingModal()">
                                <i class="fas fa-shopping-cart me-1"></i>View Plans
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading subscription data:', error);
                subscriptionDetails.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading subscription data. Please try again.
                    </div>
                `;
            }
        }

        // Load billing history
        async function loadBillingHistory() {
            const billingHistory = document.getElementById('billingHistory');
            billingHistory.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';

            try {
                // This would typically call a Firebase function to get billing history
                // For now, we'll show a placeholder
                billingHistory.innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-receipt me-2"></i>Recent Payments</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Description</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                            <th>Invoice</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="5" class="text-center text-muted py-3">
                                                <i class="fas fa-info-circle me-2"></i>
                                                Billing history will appear here after your first payment
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-outline-primary" onclick="openCustomerPortal()">
                                    <i class="fas fa-external-link-alt me-1"></i>View Full Billing History
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading billing history:', error);
                billingHistory.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading billing history. Please try again.
                    </div>
                `;
            }
        }

        // Load usage statistics
        async function loadUsageStats() {
            const usageStats = document.getElementById('usageStats');
            usageStats.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';

            try {
                // This would typically call a Firebase function to get usage stats
                // For now, we'll show a placeholder with some sample data
                usageStats.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>This Month</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <div class="border-end">
                                                <h4 class="text-primary mb-1">0</h4>
                                                <small class="text-muted">Reports Generated</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <h4 class="text-success mb-1">0</h4>
                                            <small class="text-muted">Files Processed</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-calendar me-2"></i>All Time</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <div class="border-end">
                                                <h4 class="text-primary mb-1">0</h4>
                                                <small class="text-muted">Total Reports</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <h4 class="text-success mb-1">0</h4>
                                            <small class="text-muted">Total Files</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-history me-2"></i>Recent Activity</h6>
                            </div>
                            <div class="card-body">
                                <div class="text-center text-muted py-3">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Activity history will appear here as you use the service
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading usage stats:', error);
                usageStats.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading usage statistics. Please try again.
                    </div>
                `;
            }
        }

        // Handle profile form submission
        document.addEventListener('DOMContentLoaded', function () {
            const profileForm = document.getElementById('profileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', async function (e) {
                    e.preventDefault();
                    await updateUserProfile();
                });
            }
        });

        // Update user profile
        async function updateUserProfile() {
            if (!currentUser) return;

            const displayName = document.getElementById('displayName').value.trim();
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            try {
                // Update display name
                if (displayName !== currentUser.displayName) {
                    await currentUser.updateProfile({ displayName: displayName });
                    console.log('Display name updated');
                }

                // Update password if provided
                if (newPassword) {
                    if (newPassword !== confirmPassword) {
                        throw new Error('New passwords do not match');
                    }

                    if (!currentPassword) {
                        throw new Error('Current password is required to change password');
                    }

                    // Re-authenticate user before changing password
                    const credential = firebase.auth.EmailAuthProvider.credential(
                        currentUser.email,
                        currentPassword
                    );
                    await currentUser.reauthenticateWithCredential(credential);
                    await currentUser.updatePassword(newPassword);
                    console.log('Password updated');

                    // Clear password fields
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                }

                // Show success message
                const alert = document.createElement('div');
                alert.className = 'alert alert-success alert-dismissible fade show';
                alert.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>
                    Profile updated successfully!
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

                const profileTab = document.getElementById('profile');
                profileTab.insertAdjacentElement('afterbegin', alert);

                // Update UI
                updateUIForAuthenticatedUser(currentUser);

            } catch (error) {
                console.error('Error updating profile:', error);

                const alert = document.createElement('div');
                alert.className = 'alert alert-danger alert-dismissible fade show';
                alert.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error updating profile: ${error.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

                const profileTab = document.getElementById('profile');
                profileTab.insertAdjacentElement('afterbegin', alert);
            }
        }

        // Cancel subscription
        async function cancelSubscription() {
            if (!confirm('Are you sure you want to cancel your subscription? This action cannot be undone.')) {
                return;
            }

            try {
                // This would typically call a Firebase function to cancel the subscription
                // For now, we'll redirect to the customer portal
                await openCustomerPortal();
            } catch (error) {
                console.error('Error canceling subscription:', error);
                alert('Error canceling subscription. Please try again or contact support.');
            }
        }

        // Confirm sign out
        function confirmSignOut() {
            if (confirm('Are you sure you want to sign out?')) {
                signOut();
            }
        }

        // UI update functions (removed old profile button - now handled in updateUsageDisplay)

        // Profile and usage display functions
        async function updateUsageDisplay(usageData = null) {
            const profileDropdown = document.getElementById('profileDropdown');
            if (!profileDropdown) return;

            if (!currentUser) {
                profileDropdown.innerHTML = '';
                return;
            }

            try {
                let usage;
                if (usageData) {
                    // Use provided usage data
                    usage = usageData;
                } else {
                    // Fetch current usage
                    const getCurrentUsageWithLimits = firebase.functions().httpsCallable('getCurrentUsageWithLimits');
                    const result = await getCurrentUsageWithLimits();
                    usage = result.data;
                }

                const planName = usage.planType === 'free' ? 'Free' :
                    usage.planType === 'starter' ? 'Starter' :
                        usage.planType === 'professional' ? 'Professional' : 'Enterprise';

                // Set global variable for plan checking
                window.currentUserPlan = planName;

                const previewsUsed = usage.usage.previewsGenerated || 0;
                const reportsUsed = usage.usage.reportsGenerated || 0;
                const rowsProcessed = usage.usage.rowsProcessed || 0;
                const isEnterprise = planName.toLowerCase() === 'enterprise';

                // Calculate limits and percentages
                const reportsLimit = usage.limits.monthlyReports === -1 ? '‚àû' : usage.limits.monthlyReports;
                const rowsLimit = usage.limits.maxRows === -1 ? '‚àû' : usage.limits.maxRows.toLocaleString();

                const reportsPercent = usage.limits.monthlyReports === -1 ? 0 : Math.min(100, (reportsUsed / usage.limits.monthlyReports) * 100);
                const rowsPercent = usage.limits.maxRows === -1 ? 0 : Math.min(100, (rowsProcessed / usage.limits.maxRows) * 100);

                // Plan badge styling
                const planColors = {
                    'Free': 'secondary',
                    'Starter': 'info',
                    'Professional': 'success',
                    'Enterprise': 'warning'
                };
                const planColor = planColors[planName] || 'secondary';

                // Create compact profile dropdown
                profileDropdown.innerHTML = `
                    <button class="btn btn-outline-secondary dropdown-toggle d-flex align-items-center" type="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-user-circle me-2"></i>
                        <span class="d-none d-md-inline">${currentUser.displayName || currentUser.email.split('@')[0]}</span>
                        <span class="badge bg-${planColor} ms-2">${planName}</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" style="min-width: 320px;">
                        <!-- User Info -->
                        <li class="dropdown-header">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-user-circle fs-4 me-2 text-muted"></i>
                                <div>
                                    <div class="fw-bold">${currentUser.displayName || 'User'}</div>
                                    <small class="text-muted">${currentUser.email}</small>
                                </div>
                            </div>
                        </li>
                        <li><hr class="dropdown-divider"></li>

                        <!-- Plan & Usage Summary -->
                        <li class="dropdown-header">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="badge bg-${planColor} px-2 py-1">
                                    <i class="fas fa-crown me-1"></i>${planName} Plan
                                </span>
                                ${!isEnterprise ? `<button class="btn btn-warning btn-sm" onclick="showPricingModal()">
                                    <i class="fas fa-arrow-up me-1"></i>Upgrade
                                </button>` : ''}
                            </div>
                            <div class="row g-2 text-center">
                                <div class="col-4">
                                    <div class="small text-muted">Reports</div>
                                    <div class="fw-bold">${reportsUsed}/${reportsLimit}</div>
                                    ${usage.limits.monthlyReports !== -1 ? `
                                        <div class="progress" style="height: 3px;">
                                            <div class="progress-bar bg-${reportsPercent > 80 ? 'warning' : 'success'}"
                                                 style="width: ${reportsPercent}%"></div>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="col-4">
                                    <div class="small text-muted">Previews</div>
                                    <div class="fw-bold">${previewsUsed}/${reportsLimit}</div>
                                    ${usage.limits.monthlyReports !== -1 ? `
                                        <div class="progress" style="height: 3px;">
                                            <div class="progress-bar bg-info"
                                                 style="width: ${Math.min(100, (previewsUsed / usage.limits.monthlyReports) * 100)}%"></div>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="col-4">
                                    <div class="small text-muted">Rows</div>
                                    <div class="fw-bold">${rowsProcessed.toLocaleString()}</div>
                                    <div class="small text-muted">/${rowsLimit}</div>
                                </div>
                            </div>
                        </li>
                        <li><hr class="dropdown-divider"></li>

                        <!-- Account Actions -->
                        ${isEnterprise ? `
                        <li>
                            <a class="dropdown-item" href="#" onclick="showWhiteLabelModal()">
                                <i class="fas fa-palette me-2"></i>Customize Branding
                            </a>
                        </li>
                        ` : ''}
                        <li>
                            <a class="dropdown-item" href="#" onclick="showPricingModal()">
                                <i class="fas fa-credit-card me-2"></i>Billing & Plans
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item text-danger" href="#" onclick="signOut()">
                                <i class="fas fa-sign-out-alt me-2"></i>Sign Out
                            </a>
                        </li>
                    </ul>
                `;

            } catch (error) {
                console.error('Error updating usage display:', error);
                profileDropdown.innerHTML = `
                    <button class="btn btn-outline-secondary" type="button">
                        <i class="fas fa-user-circle me-2"></i>
                        <span class="d-none d-md-inline">${currentUser.email.split('@')[0]}</span>
                    </button>
                `;
            }
        }

        // Make updateUsageDisplay globally available
        window.updateUsageDisplay = updateUsageDisplay;

        // White Label Functions
        function showWhiteLabelModal() {
            // Check if user has Enterprise plan
            if (!window.currentUserPlan || window.currentUserPlan.toLowerCase() !== 'enterprise') {
                alert('White label customization is only available for Enterprise plan users. Please upgrade to access this feature.');
                showPricingModal();
                return;
            }

            const modal = new bootstrap.Modal(document.getElementById('whiteLabelModal'));
            loadWhiteLabelSettings();
            modal.show();
        }

        function loadWhiteLabelSettings() {
            // Load existing white label settings from localStorage or Firebase
            const settings = JSON.parse(localStorage.getItem('whiteLabelSettings') || '{}');

            document.getElementById('companyName').value = settings.companyName || '';
            document.getElementById('applicationTitle').value = settings.applicationTitle || '';
            document.getElementById('primaryColor').value = settings.primaryColor || '#0d6efd';
            document.getElementById('secondaryColor').value = settings.secondaryColor || '#6c757d';
            document.getElementById('accentColor').value = settings.accentColor || '#ffc107';
            document.getElementById('darkMode').checked = settings.darkMode || false;
            document.getElementById('hideFooter').checked = settings.hideFooter || false;
            document.getElementById('customFavicon').checked = settings.customFavicon || false;
            document.getElementById('customCSS').value = settings.customCSS || '';
        }

        async function saveWhiteLabelSettings() {
            try {
                const settings = {
                    companyName: document.getElementById('companyName').value,
                    applicationTitle: document.getElementById('applicationTitle').value,
                    primaryColor: document.getElementById('primaryColor').value,
                    secondaryColor: document.getElementById('secondaryColor').value,
                    accentColor: document.getElementById('accentColor').value,
                    darkMode: document.getElementById('darkMode').checked,
                    hideFooter: document.getElementById('hideFooter').checked,
                    customFavicon: document.getElementById('customFavicon').checked,
                    customCSS: document.getElementById('customCSS').value,
                    lastUpdated: new Date().toISOString()
                };

                // Save to localStorage for immediate use
                localStorage.setItem('whiteLabelSettings', JSON.stringify(settings));

                // Save to Firebase for persistence
                if (currentUser) {
                    const db = firebase.firestore();
                    await db.collection('whiteLabelSettings').doc(currentUser.uid).set(settings);
                }

                // Apply settings immediately
                applyWhiteLabelSettings(settings);

                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('whiteLabelModal'));
                modal.hide();

                // Show success message
                alert('White label settings saved successfully!');

            } catch (error) {
                console.error('Error saving white label settings:', error);
                alert('Error saving settings. Please try again.');
            }
        }

        function previewWhiteLabel() {
            const settings = {
                companyName: document.getElementById('companyName').value,
                applicationTitle: document.getElementById('applicationTitle').value,
                primaryColor: document.getElementById('primaryColor').value,
                secondaryColor: document.getElementById('secondaryColor').value,
                accentColor: document.getElementById('accentColor').value,
                darkMode: document.getElementById('darkMode').checked,
                hideFooter: document.getElementById('hideFooter').checked,
                customCSS: document.getElementById('customCSS').value
            };

            applyWhiteLabelSettings(settings);
        }

        function applyWhiteLabelSettings(settings) {
            // Apply company name and title
            if (settings.companyName) {
                const titleElements = document.querySelectorAll('h1, .navbar-brand');
                titleElements.forEach(el => {
                    if (el.textContent.includes('Azure Billing Report Generator')) {
                        el.innerHTML = `<i class="fas fa-sitemap me-2"></i>${settings.applicationTitle || settings.companyName + ' Billing Reports'}`;
                    }
                });
            }

            // Apply color scheme
            const root = document.documentElement;
            if (settings.primaryColor) {
                root.style.setProperty('--bs-primary', settings.primaryColor);
            }
            if (settings.secondaryColor) {
                root.style.setProperty('--bs-secondary', settings.secondaryColor);
            }
            if (settings.accentColor) {
                root.style.setProperty('--bs-warning', settings.accentColor);
            }

            // Apply dark mode
            if (settings.darkMode) {
                document.body.setAttribute('data-bs-theme', 'dark');
            } else {
                document.body.removeAttribute('data-bs-theme');
            }

            // Hide footer if requested
            const footer = document.querySelector('footer, .footer');
            if (footer) {
                footer.style.display = settings.hideFooter ? 'none' : 'block';
            }

            // Apply custom CSS
            let customStyleElement = document.getElementById('customWhiteLabelStyles');
            if (!customStyleElement) {
                customStyleElement = document.createElement('style');
                customStyleElement.id = 'customWhiteLabelStyles';
                document.head.appendChild(customStyleElement);
            }
            customStyleElement.textContent = settings.customCSS || '';
        }

        // Load white label settings on page load
        function loadAndApplyWhiteLabelSettings() {
            const settings = JSON.parse(localStorage.getItem('whiteLabelSettings') || '{}');
            if (Object.keys(settings).length > 0) {
                applyWhiteLabelSettings(settings);
            }
        }

        function updateUIForAuthenticatedUser(user) {
            // Update usage display and profile
            updateUsageDisplay();
            // Update license panel with user info
            const licensePanel = document.getElementById('licensePanel');
            const userInfo = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h5 class="mb-1">
                            <i class="fas fa-user me-2"></i>Welcome, ${user.displayName || user.email}
                        </h5>
                        <small>${user.email}</small>
                    </div>
                    <div class="d-flex align-items-center">
                        <button type="button" class="btn btn-sm btn-outline-light me-2" onclick="showUserDashboard()">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </button>
                        <button type="button" class="buy-license-btn" onclick="showPricingModal()">
                            <i class="fas fa-shopping-cart me-1"></i>Buy License
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-light ms-2" onclick="signOut()">
                            <i class="fas fa-sign-out-alt me-1"></i>Sign Out
                        </button>
                    </div>
                </div>
            `;

            // Check if user has active subscription
            checkSubscriptionStatus().then(subscription => {
                if (subscription && subscription.hasSubscription && subscription.status === 'active') {
                    licensePanel.classList.add('licensed');
                    licensePanel.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1"><i class="fas fa-check-circle me-2"></i>Active Subscription</h5>
                                <small>${user.displayName || user.email} ‚Ä¢ Plan: ${subscription.plan.charAt(0).toUpperCase() + subscription.plan.slice(1)}</small>
                                ${subscription.currentPeriodEnd ? `<br><small>Next billing: ${new Date(subscription.currentPeriodEnd.seconds * 1000).toLocaleDateString()}</small>` : ''}
                            </div>
                            <div>
                                <span class="license-badge">
                                    <i class="fas fa-certificate me-1"></i>Active
                                </span>
                                <button class="btn btn-sm btn-outline-light ms-2" onclick="openCustomerPortal()">
                                    <i class="fas fa-cog me-1"></i>Manage
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-light ms-2" onclick="showProfileModal()">
                                    <i class="fas fa-user-cog me-1"></i>Profile
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-light ms-2" onclick="signOut()">
                                    <i class="fas fa-sign-out-alt me-1"></i>Sign Out
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    licensePanel.classList.remove('licensed');
                    licensePanel.innerHTML = userInfo;
                }
            });
        }

        function updateUIForAnonymousUser() {
            // Clear profile dropdown for anonymous users
            const profileDropdown = document.getElementById('profileDropdown');
            if (profileDropdown) {
                profileDropdown.innerHTML = '';
            }

            // Hide usage display for anonymous users
            const usageDisplay = document.getElementById('usageDisplay');
            if (usageDisplay) {
                usageDisplay.style.display = 'none';
            }

            const licensePanel = document.getElementById('licensePanel');
            licensePanel.classList.remove('licensed');
            licensePanel.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h5 class="mb-1"><i class="fas fa-key me-2"></i>Demo Mode</h5>
                        <small>Upgrade your subscription to unlock unlimited features</small>
                    </div>
                    <div class="d-flex align-items-center">
                        <button type="button" class="btn btn-sm btn-outline-light me-2" onclick="showAboutDialog()">
                            <i class="fas fa-info-circle me-1"></i>About
                        </button>
                        <button type="button" class="buy-license-btn" onclick="showPricingModal()">
                            <i class="fas fa-shopping-cart me-1"></i>Buy License
                        </button>
                    </div>
                </div>
            `;
        }

        // Start checkout process
        async function startCheckout(planType) {
            try {
                // Require proper authentication for subscriptions
                if (!currentUser) {
                    showLoginWall();
                    return;
                }

                // Show loading state
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Loading...';
                button.disabled = true;

                // Create checkout session
                const createCheckoutSession = functions.httpsCallable('createCheckoutSession');
                const result = await createCheckoutSession({
                    planType: planType,
                    returnUrl: window.location.origin
                });

                // Redirect to Stripe Checkout
                window.location.href = result.data.url;

            } catch (error) {
                console.error('Error starting checkout:', error);
                alert('Error starting checkout. Please try again.');

                // Reset button
                const button = event.target;
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Handle URL parameters on page load
        function handleURLParameters() {
            const urlParams = new URLSearchParams(window.location.search);

            // Handle email verification return
            const emailVerified = urlParams.get('emailVerified');
            if (emailVerified === 'true') {
                // Show success message for email verification
                setTimeout(() => {
                    if (currentUser && currentUser.emailVerified) {
                        const successAlert = document.createElement('div');
                        successAlert.className = 'alert alert-success alert-dismissible fade show';
                        successAlert.innerHTML = `
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Email Verified!</strong> Your account is now fully activated.
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;

                        const container = document.querySelector('.container-fluid');
                        if (container) {
                            container.insertAdjacentElement('afterbegin', successAlert);
                        }
                    }
                }, 1000);

                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }

            // Handle checkout success
            handleCheckoutSuccess();
        }

        // Handle successful checkout return
        function handleCheckoutSuccess() {
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session_id');
            const success = urlParams.get('success');

            if (success === 'true' && sessionId) {
                // Show success message
                const successAlert = document.createElement('div');
                successAlert.className = 'alert alert-success alert-dismissible fade show';
                successAlert.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Welcome to Azure Billing Pro!</strong> Your subscription is now active.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('.container').insertBefore(successAlert, document.querySelector('.container').firstChild);

                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);

                // Refresh subscription status
                checkSubscriptionStatus();
            }
        }

        // Set up real-time subscription listener
        function setupSubscriptionListener(userId) {
            if (subscriptionListener) {
                subscriptionListener();
            }

            subscriptionListener = db.collection('subscriptions').doc(userId)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const subscriptionData = doc.data();
                        console.log('üîÑ Subscription updated:', subscriptionData);

                        if (subscriptionData.status === 'active') {
                            // Refresh the full subscription status
                            checkSubscriptionStatus();
                        }
                    }
                }, (error) => {
                    console.error('Error listening to subscription changes:', error);
                });
        }

        // Check subscription status
        async function checkSubscriptionStatus() {
            if (!currentUser) return null;

            try {
                const getSubscriptionStatus = functions.httpsCallable('getSubscriptionStatus');
                const result = await getSubscriptionStatus();
                const subscription = result.data;

                console.log('üìä Subscription status:', subscription);

                if (subscription.hasSubscription && subscription.status === 'active') {
                    // Update UI for active subscription
                    updateUIForActiveSubscription(subscription);
                } else {
                    // Update UI for no subscription
                    updateUIForNoSubscription();
                }

                return subscription;
            } catch (error) {
                console.error('Error checking subscription status:', error);
                return null;
            }
        }

        // Update UI for active subscription
        function updateUIForActiveSubscription(subscription) {
            // Update license panel
            const licensePanel = document.getElementById('licensePanel');
            licensePanel.classList.add('licensed');

            if (subscription.isMasterAccount) {
                licensePanel.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1"><i class="fas fa-crown me-2 text-warning"></i>Master Account</h5>
                            <small>Unlimited Access ‚Ä¢ Full Tier Features</small>
                            <br><small>Testing account with unlimited usage</small>
                        </div>
                        <div>
                            <span class="license-badge bg-warning text-dark">
                                <i class="fas fa-crown me-1"></i>Master
                            </span>
                        </div>
                    </div>
                `;
            } else {
                licensePanel.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1"><i class="fas fa-check-circle me-2"></i>Active Subscription</h5>
                            <small>Plan: ${subscription.plan.charAt(0).toUpperCase() + subscription.plan.slice(1)}</small>
                            ${subscription.currentPeriodEnd ? `<br><small>Next billing: ${new Date(subscription.currentPeriodEnd.seconds * 1000).toLocaleDateString()}</small>` : ''}
                        </div>
                        <div>
                            <span class="license-badge">
                                <i class="fas fa-certificate me-1"></i>Active
                            </span>
                            <button class="btn btn-sm btn-outline-light ms-2" onclick="openCustomerPortal()">
                                <i class="fas fa-cog me-1"></i>Manage
                            </button>
                        </div>
                    </div>
                `;
            }

            // Update feature flags
            window.FEATURE_FLAGS.isLicensed = true;
            window.FEATURE_FLAGS.brandingEnabled = subscription.features.customBranding;
            window.FEATURE_FLAGS.limits.maxRows = subscription.features.maxRows === -1 ? Infinity : subscription.features.maxRows;

            // Remove demo watermark
            const watermark = document.getElementById('demoWatermark');
            if (watermark) watermark.remove();

            // Hide pricing section
            const pricingSection = document.getElementById('pricingSection');
            if (pricingSection) {
                pricingSection.style.display = 'none';
            }

            // Update any "Buy License" buttons to show subscription status
            const buyButtons = document.querySelectorAll('[onclick*="buyLicense"]');
            buyButtons.forEach(button => {
                if (subscription.isMasterAccount) {
                    button.innerHTML = '<i class="fas fa-crown me-1"></i>Master Account';
                    button.className = 'btn btn-warning';
                } else {
                    button.innerHTML = '<i class="fas fa-check-circle me-1"></i>Active Subscription';
                    button.className = 'btn btn-success';
                }
                button.onclick = null;
            });

            console.log('‚úÖ UI updated for active subscription:', subscription.plan);
        }

        // Update UI for no subscription
        function updateUIForNoSubscription() {
            console.log('‚ö†Ô∏è Updating UI for no subscription');

            // Update license panel
            const licensePanel = document.getElementById('licensePanel');
            if (licensePanel) {
                licensePanel.classList.remove('licensed');
                licensePanel.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1"><i class="fas fa-exclamation-triangle me-2"></i>No Active Subscription</h5>
                            <small>Upgrade to unlock unlimited reports and premium features</small>
                        </div>
                        <div>
                            <button class="btn btn-primary" onclick="showPricingModal()">
                                <i class="fas fa-shopping-cart me-1"></i>Buy License
                            </button>
                        </div>
                    </div>
                `;
            }

            // Show pricing section
            const pricingSection = document.getElementById('pricingSection');
            if (pricingSection) {
                pricingSection.style.display = 'block';
            }

            // Reset feature flags
            window.FEATURE_FLAGS.isLicensed = false;
            window.FEATURE_FLAGS.brandingEnabled = false;
            window.FEATURE_FLAGS.limits.maxRows = 25000;
        }

        // Open customer portal
        async function openCustomerPortal() {
            try {
                const createPortalSession = functions.httpsCallable('createPortalSession');
                const result = await createPortalSession({
                    returnUrl: window.location.origin
                });

                window.open(result.data.url, '_blank');
            } catch (error) {
                console.error('Error opening customer portal:', error);

                // Check if it's a master account error
                if (error.message && error.message.includes('Master accounts do not require billing management')) {
                    alert('Master accounts do not require billing management. You have unlimited access to all features.');
                } else {
                    alert('Error opening customer portal. Please try again.');
                }
            }
        }

        // Customer profile and CRM functions
        async function updateCustomerProfile(user) {
            if (!user) return;

            try {
                const updateProfile = functions.httpsCallable('updateCustomerProfile');
                await updateProfile({
                    email: user.email,
                    displayName: user.displayName,
                    photoURL: user.photoURL,
                    provider: user.providerData[0]?.providerId || 'email',
                    lastLogin: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                });
            } catch (error) {
                console.error('Error updating customer profile:', error);
            }
        }

        function updateProfileModal() {
            if (!currentUser) return;

            const profileContent = document.getElementById('profileContent');
            profileContent.innerHTML = `
                <div class="row">
                    <div class="col-md-4 text-center">
                        <img src="${currentUser.photoURL || 'https://via.placeholder.com/150'}"
                             class="rounded-circle mb-3" width="150" height="150" alt="Profile">
                        <h5>${currentUser.displayName || 'User'}</h5>
                        <p class="text-muted">${currentUser.email}</p>
                    </div>
                    <div class="col-md-8">
                        <h6><i class="fas fa-info-circle me-2"></i>Account Information</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Email:</strong></td>
                                <td>${currentUser.email}</td>
                            </tr>
                            <tr>
                                <td><strong>Display Name:</strong></td>
                                <td>${currentUser.displayName || 'Not set'}</td>
                            </tr>
                            <tr>
                                <td><strong>Provider:</strong></td>
                                <td>${currentUser.providerData[0]?.providerId || 'email'}</td>
                            </tr>
                            <tr>
                                <td><strong>Account Created:</strong></td>
                                <td>${new Date(currentUser.metadata.creationTime).toLocaleDateString()}</td>
                            </tr>
                            <tr>
                                <td><strong>Last Sign In:</strong></td>
                                <td>${new Date(currentUser.metadata.lastSignInTime).toLocaleDateString()}</td>
                            </tr>
                        </table>

                        <h6 class="mt-4"><i class="fas fa-chart-bar me-2"></i>Usage Statistics</h6>
                        <div id="usageStats">Loading...</div>

                        <h6 class="mt-4"><i class="fas fa-credit-card me-2"></i>Subscription</h6>
                        <div id="subscriptionInfo">Loading...</div>
                    </div>
                </div>

                <div class="text-end mt-4">
                    <button type="button" class="btn btn-outline-secondary me-2" onclick="downloadUserData()">
                        <i class="fas fa-download me-1"></i>Download My Data
                    </button>
                    <button type="button" class="btn btn-success" onclick="openCustomerPortal()">
                        <i class="fas fa-cog me-1"></i>Manage Billing
                    </button>
                </div>
            `;

            // Load usage statistics
            loadUsageStatistics();
            loadSubscriptionInfo();
        }

        async function loadUsageStatistics() {
            try {
                const getUsageStats = functions.httpsCallable('getUserUsageStats');
                const result = await getUsageStats();
                const stats = result.data;

                document.getElementById('usageStats').innerHTML = `
                    <div class="row">
                        <div class="col-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h4 class="text-primary">${stats.currentMonth?.reportsGenerated || 0}</h4>
                                    <small>Reports This Month</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h4 class="text-success">${(stats.currentMonth?.rowsProcessed || 0).toLocaleString()}</h4>
                                    <small>Rows Processed</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('usageStats').innerHTML = '<p class="text-muted">Unable to load usage statistics</p>';
            }
        }

        async function loadSubscriptionInfo() {
            try {
                const subscription = await checkSubscriptionStatus();

                if (subscription && subscription.hasSubscription) {
                    document.getElementById('subscriptionInfo').innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>${subscription.plan.charAt(0).toUpperCase() + subscription.plan.slice(1)} Plan</strong>
                            <br><small>Status: ${subscription.status}</small>
                            ${subscription.currentPeriodEnd ? `<br><small>Next billing: ${new Date(subscription.currentPeriodEnd.seconds * 1000).toLocaleDateString()}</small>` : ''}
                        </div>
                    `;
                } else {
                    document.getElementById('subscriptionInfo').innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>No Active Subscription</strong>
                            <br><small>You're currently using the demo version</small>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('subscriptionInfo').innerHTML = '<p class="text-muted">Unable to load subscription information</p>';
            }
        }

        async function downloadUserData() {
            try {
                const getUserData = functions.httpsCallable('getUserData');
                const result = await getUserData();

                const dataStr = JSON.stringify(result.data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });

                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `azure-billing-user-data-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
            } catch (error) {
                console.error('Error downloading user data:', error);
                alert('Error downloading user data. Please try again.');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function () {
            handleURLParameters();

            // Initialize profile dropdown (will be populated when user signs in)

            // Show login wall by default (will be hidden if user is already authenticated)
            showLoginWall();

            // Check subscription status after a short delay
            setTimeout(() => {
                if (currentUser) {
                    checkSubscriptionStatus();
                }
            }, 1000);
        });
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Authentication Test Script (Development) -->
    <script>
        // Add test button for development
        if (window.location.hostname === 'localhost' || window.location.hostname.includes('azreports-cafas')) {
            document.addEventListener('DOMContentLoaded', function () {
                const testButton = document.createElement('button');
                testButton.innerHTML = '<i class="fas fa-bug me-1"></i>Test Auth';
                testButton.className = 'btn btn-sm btn-outline-secondary position-fixed';
                testButton.style.cssText = 'bottom: 20px; right: 20px; z-index: 1000;';
                testButton.onclick = function () {
                    // Run authentication tests
                    console.log('üß™ Running Authentication Tests...');

                    // Test Firebase configuration
                    console.log('Firebase App:', firebase.app().options.projectId);
                    console.log('Current User:', currentUser?.email || 'Not authenticated');
                    console.log('Auth State:', currentUser?.isAnonymous ? 'Anonymous' : 'Authenticated');

                    // Test UI elements
                    const elements = ['licensePanel', 'loginModal', 'profileModal', 'pricingModal'];
                    elements.forEach(id => {
                        const element = document.getElementById(id);
                        console.log(`${id}:`, element ? 'Found' : 'Missing');
                    });

                    // Test authentication functions
                    const authFunctions = ['signInWithGoogle', 'signInWithEmail', 'showLoginModal'];
                    authFunctions.forEach(func => {
                        console.log(`${func}:`, typeof window[func] === 'function' ? 'Available' : 'Missing');
                    });

                    console.log('‚úÖ Authentication test completed. Check console for details.');
                };
                document.body.appendChild(testButton);
            });
        }
    </script>
</body>

</html>